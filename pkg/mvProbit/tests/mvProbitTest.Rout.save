
R version 3.2.2 (2015-08-14) -- "Fire Safety"
Copyright (C) 2015 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> library( "mvProbit" )
Loading required package: mvtnorm
Loading required package: maxLik
Loading required package: miscTools

Please cite the 'maxLik' package as:
Henningsen, Arne and Toomet, Ott (2011). maxLik: A package for maximum likelihood estimation in R. Computational Statistics 26(3), 443-458. DOI 10.1007/s00180-010-0217-1.

If you have questions, suggestions, or comments regarding the 'maxLik' package, please use a forum or 'tracker' at maxLik's R-Forge site:
https://r-forge.r-project.org/projects/maxlik/
Loading required package: abind
> options( digits = 4 )
> 
> ## generate a simulated data set
> set.seed( 123 )
> # number of observations
> nObs <- 10
> 
> # generate explanatory variables
> xMat <- cbind( 
+    const = rep( 1, nObs ),
+    x1 = as.numeric( rnorm( nObs ) > 0 ),
+    x2 = as.numeric( rnorm( nObs ) > 0 ),
+    x3 = rnorm( nObs ),
+    x4 = rnorm( nObs ) )
> 
> # model coefficients
> beta <- cbind( c(  0.8,  1.2, -1.0,  1.4, -0.8 ),
+                c( -0.6,  1.0,  0.6, -1.2, -1.6 ),
+                c(  0.5, -0.6, -0.7,  1.1,  1.2 ) )
> 
> # covariance matrix of error terms
> sigma <- miscTools::symMatrix( c( 1, 0.2, 0.4, 1, -0.1, 1 ) )
> 
> # all parameters in a vector
> allCoef <- c( c( beta ), sigma[ lower.tri( sigma ) ] )
> 
> # generate dependent variables
> yMatLin <- xMat %*% beta 
> yMat <- ( yMatLin + rmvnorm( nObs, sigma = sigma, pre0.9_9994 = TRUE ) ) > 0
> colnames( yMat ) <- paste( "y", 1:3, sep = "" )
> # (yMatLin > 0 )== yMat
> 
> # unconditional expectations of dependent variables
> yExp <- mvProbitExp( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ) )
> round( yExp, 3 )
      V1    V2    V3
1  0.021 0.725 0.194
2  0.394 0.768 0.214
3  0.125 0.788 0.196
4  0.235 0.681 0.292
5  0.680 0.435 0.579
6  0.028 0.973 0.034
7  0.958 0.186 0.784
8  0.856 0.247 0.724
9  0.061 0.968 0.034
10 0.998 0.067 0.923
> yExpA <- mvProbitExp( ~ x1 + x2 + x3 + x4, coef = allCoef,
+    data = as.data.frame( xMat ) )
> all.equal( yExp, yExpA )
[1] TRUE
> yExp2 <- pnorm( yMatLin )
> all.equal( yExp, as.data.frame( yExp2 ) )
[1] TRUE
> 
> 
> # conditional expectations of dependent variables
> # (assuming that all other dependent variables are one)
> yExpCond <- mvProbitExp( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE,
+    algorithm = GenzBretz() )
> round( yExpCond, 3 )
      V1    V2    V3
1  0.072 0.834 0.524
2  0.660 0.779 0.314
3  0.297 0.838 0.399
4  0.448 0.727 0.461
5  0.847 0.442 0.618
6  0.139 0.985 0.162
7  0.991 0.179 0.749
8  0.950 0.244 0.710
9  0.244 0.978 0.133
10 1.000 0.065 0.892
> yExpCondA <- mvProbitExp( ~ x1 + x2 + x3 + x4, coef = allCoef,
+    data = as.data.frame( xMat ), cond = TRUE,
+    algorithm = GenzBretz() )
> all.equal( yExpCond, yExpCondA )
[1] TRUE
> yExpCond2 <- matrix( NA, nrow = nObs, ncol = ncol( yMat ) )
> for( i in 1:nObs ) {
+    for( k in 1:ncol( yMat ) ) {
+       set.seed( 123 )
+       numerator <- pmvnorm( upper = yMatLin[ i, ], sigma = sigma )
+       set.seed( 123 )
+       denominator <- pmvnorm( upper = yMatLin[ i, -k ], sigma = sigma[ -k, -k ] )
+       yExpCond2[ i, k ] <- numerator / denominator
+    }
+ }
> all.equal( yExpCond, as.data.frame( yExpCond2 ) )
[1] TRUE
> # now with explicitly specifying the algorithm
> yExpCond3 <- mvProbitExp( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE,
+    algorithm = GenzBretz )
> all.equal( yExpCond, yExpCond3 )
[1] TRUE
> identical( yExpCond, yExpCond3 )
[1] TRUE
> # now with integrals obtained by the Miwa algorithm
> yExpCond4 <- mvProbitExp( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE,
+    algorithm = Miwa )
> all.equal( yExpCond, yExpCond4, tol = 1e-3 )
[1] TRUE
> # now with integrals obtained by the Miwa algorithm, less precise
> yExpCond5 <- mvProbitExp( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE,
+    algorithm = Miwa( steps = 32 ) )
> all.equal( yExpCond4, yExpCond5, tol = 1e-3 )
[1] TRUE
> # now with integrals obtained by the TVPACK algorithm
> yExpCond6 <- mvProbitExp( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE,
+    algorithm = TVPACK )
> all.equal( yExpCond, yExpCond6, tol = 1e-3 )
[1] TRUE
> # now with integrals obtained by the TVPACK algorithm, less precise
> yExpCond7 <- mvProbitExp( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE,
+    algorithm = TVPACK( abseps = 0.5 ) )
> all.equal( yExpCond6, yExpCond7, tol = 1e-3 )
[1] "Component \"V1\": Mean relative difference: 0.03018"
[2] "Component \"V2\": Mean relative difference: 0.04273"
[3] "Component \"V3\": Mean relative difference: 0.04242"
> # now with integrals obtained by the GHK algorithm
> yExpCond8 <- mvProbitExp( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE )
> all.equal( yExpCond, yExpCond8, tol = 1e-3 )
[1] TRUE
> # now with integrals obtained by the GHK algorithm, less precise
> yExpCond9 <- mvProbitExp( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE,
+    nGHK = 100 )
> all.equal( yExpCond8, yExpCond9, tol = 1e-3 )
[1] "Component \"V1\": Mean relative difference: 0.004212"
[2] "Component \"V2\": Mean relative difference: 0.00124" 
[3] "Component \"V3\": Mean relative difference: 0.001381"
> 
> 
> # conditional expectations of dependent variables
> # (assuming that all other dependent variables are as observed)
> yExpCondObs <- mvProbitExp( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ), 
+    cond = TRUE, algorithm = GenzBretz() )
> round( yExpCondObs, 3 )
      y1    y2    y3
1  0.014 0.735 0.172
2  0.364 0.744 0.119
3  0.102 0.788 0.152
4  0.197 0.813 0.461
5  0.469 0.542 0.707
6  0.025 0.973 0.029
7  0.971 0.179 0.809
8  0.890 0.244 0.783
9  0.056 0.968 0.027
10 0.999 0.065 0.926
> yExpCondObsA <- mvProbitExp( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = allCoef, data = as.data.frame( cbind( xMat, yMat ) ), 
+    cond = TRUE, algorithm = GenzBretz() )
> all.equal( yExpCondObs, yExpCondObsA )
[1] TRUE
> yExpCondObs2 <- matrix( NA, nrow = nObs, ncol = ncol( yMat ) )
> for( i in 1:nObs ){
+    for( k in 1:ncol( yMat ) ) {
+       ySign <- 2 * yMat[ i, ] - 1
+       ySign[ k ] <- 1
+       yLinTmp <- yMatLin[ i, ] * ySign
+       sigmaTmp <- diag( ySign ) %*% sigma %*% diag( ySign )
+       set.seed( 123 )
+       numerator <- pmvnorm( upper = yLinTmp, sigma = sigmaTmp )
+       set.seed( 123 )
+       denominator <- pmvnorm( upper = yLinTmp[ -k ], sigma = sigmaTmp[ -k, -k ] )
+       yExpCondObs2[ i, k ] <- numerator / denominator
+    }
+ }
> all.equal( yExpCondObs, as.data.frame( yExpCondObs2 ) )
[1] "Names: 3 string mismatches"
> # now with explicitly specifying the algorithm
> yExpCondObs3 <- mvProbitExp( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    cond = TRUE, algorithm = GenzBretz )
> all.equal( yExpCondObs, yExpCondObs3 )
[1] TRUE
> identical( yExpCondObs, yExpCondObs3 )
[1] TRUE
> # now with integrals obtained by the Miwa algorithm
> yExpCondObs4 <- mvProbitExp( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    cond = TRUE, algorithm = Miwa )
> all.equal( yExpCondObs, yExpCondObs4, tol = 1e-3 )
[1] TRUE
> # now with integrals obtained by the Miwa algorithm, less precise
> yExpCondObs5 <- mvProbitExp( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    cond = TRUE, algorithm = Miwa( steps = 32 ) )
> all.equal( yExpCondObs4, yExpCondObs5, tol = 1e-3 )
[1] TRUE
> # now with integrals obtained by the TVPACK algorithm
> yExpCondObs6 <- mvProbitExp( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    cond = TRUE, algorithm = TVPACK )
> all.equal( yExpCondObs, yExpCondObs6, tol = 1e-3 )
[1] TRUE
> # now with integrals obtained by the TVPACK algorithm, less precise
> yExpCondObs7 <- mvProbitExp( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    cond = TRUE, algorithm = TVPACK( abseps = 0.5 ) )
> all.equal( yExpCondObs6, yExpCondObs7, tol = 1e-3 )
[1] "Component \"y1\": Mean relative difference: 0.0513" 
[2] "Component \"y2\": Mean relative difference: 0.04744"
[3] "Component \"y3\": Mean relative difference: 0.02587"
> # now with integrals obtained by the GHK algorithm
> yExpCondObs8 <- mvProbitExp( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    cond = TRUE )
> all.equal( yExpCondObs, yExpCondObs8, tol = 1e-3 )
[1] TRUE
> # now with integrals obtained by the GHK algorithm, less precise
> yExpCondObs9 <- mvProbitExp( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    cond = TRUE, nGHK = 100 )
> all.equal( yExpCondObs8, yExpCondObs9, tol = 1e-3 )
[1] "Component \"y1\": Mean relative difference: 0.00177" 
[2] "Component \"y3\": Mean relative difference: 0.003009"
> 
> 
> # unconditional expectations of dependent variables by simulation
> nSim <- 10000
> ySim <- array( NA, c( nObs, ncol( yMat ), nSim ) )
> for( s in 1:nSim ) {
+    ySim[ , , s ] <- ( yMatLin + rmvnorm( nObs, sigma = sigma, pre0.9_9994 = TRUE ) ) > 0
+ }
> yExpSim <- matrix( NA, nrow = nObs, ncol = ncol( yMat ) )
> for( i in 1:nObs ) {
+    yExpSim[ i, ] <- rowSums( ySim[ i, , ] ) / nSim
+ }
> round( yExpSim, 3 )
       [,1]  [,2]  [,3]
 [1,] 0.019 0.729 0.197
 [2,] 0.400 0.760 0.215
 [3,] 0.118 0.787 0.198
 [4,] 0.237 0.684 0.299
 [5,] 0.682 0.437 0.578
 [6,] 0.028 0.971 0.036
 [7,] 0.958 0.184 0.787
 [8,] 0.855 0.255 0.716
 [9,] 0.062 0.970 0.033
[10,] 0.998 0.064 0.923
> round( yExpSim - as.matrix( yExp ), 3 )
          V1     V2     V3
 [1,] -0.002  0.004  0.003
 [2,]  0.006 -0.009  0.001
 [3,] -0.006 -0.001  0.001
 [4,]  0.003  0.004  0.007
 [5,]  0.002  0.002 -0.001
 [6,]  0.000 -0.002  0.002
 [7,]  0.000 -0.002  0.003
 [8,] -0.001  0.008 -0.008
 [9,]  0.002  0.001 -0.001
[10,]  0.001 -0.004  0.001
> 
> # for testing state of random number generator
> rnorm( 4 )
[1] -0.07305  0.71129  0.08263 -1.11817
> 
> # calculating log likelihood value(s)
> logLikVal <- mvProbitLogLik( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    algorithm = GenzBretz() )
> round( logLikVal, 3 )
 [1] -0.535 -0.942 -0.552 -2.327 -2.259 -0.086 -0.466 -0.704 -0.124 -0.149
> logLikValA <- mvProbitLogLik( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = allCoef, data = as.data.frame( cbind( xMat, yMat ) ),
+    algorithm = GenzBretz() )
> all.equal( logLikVal, logLikValA )
[1] TRUE
> # now with explicitly specifying the algorithm
> logLikVal3 <- mvProbitLogLik( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    algorithm = GenzBretz )
> all.equal( logLikVal, logLikVal3 )
[1] TRUE
> identical( logLikVal, logLikVal3 )
[1] TRUE
> # now with integrals obtained by the Miwa algorithm
> logLikVal4 <- mvProbitLogLik( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    algorithm = Miwa )
> all.equal( logLikVal, logLikVal4, tol = 1e-3 )
[1] TRUE
> # now with integrals obtained by the Miwa algorithm, less precise
> logLikVal5 <- mvProbitLogLik( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    algorithm = Miwa( steps = 32 ) )
> all.equal( logLikVal4, logLikVal5, tol = 1e-3 )
[1] TRUE
> # now with integrals obtained by the TVPACK algorithm
> logLikVal6 <- mvProbitLogLik( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    algorithm = TVPACK )
> all.equal( logLikVal, logLikVal6, tol = 1e-3 )
[1] TRUE
> # now with integrals obtained by the TVPACK algorithm, less precise
> logLikVal7 <- mvProbitLogLik( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    algorithm = TVPACK( abseps = 0.5 ) )
> all.equal( logLikVal6, logLikVal7, tol = 1e-3 )
[1] "Mean relative difference: 0.05527"
> # now with integrals obtained by the GHK algorithm
> logLikVal8 <- mvProbitLogLik( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ) )
> all.equal( logLikVal, logLikVal8, tol = 1e-3 )
[1] TRUE
> # now with integrals obtained by the GHK algorithm, less precise
> logLikVal9 <- mvProbitLogLik( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    nGHK = 100 )
> all.equal( logLikVal8, logLikVal9, tol = 1e-3 )
[1] "Mean relative difference: 0.001901"
> 
> # calculating log likelihood value(s) with one-sided gradients
> logLikValGrad1 <- mvProbitLogLik( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    oneSidedGrad = TRUE, algorithm = GenzBretz() )
> round( c( logLikValGrad1 ), 3 )
 [1] -0.535 -0.942 -0.552 -2.327 -2.259 -0.086 -0.466 -0.704 -0.124 -0.149
> round( attr( logLikValGrad1, "gradient" ), 3 )
       b_1_0  b_1_1  b_1_2  b_1_3  b_1_4  b_2_0  b_2_1  b_2_2  b_2_3  b_2_4
 [1,] -0.039  0.000 -0.039  0.042 -0.017  0.447  0.000  0.447 -0.477  0.191
 [2,] -0.620  0.000 -0.620  0.135  0.183  0.438  0.000  0.438 -0.096 -0.129
 [3,] -0.209 -0.209 -0.209  0.214 -0.187  0.371  0.371  0.371 -0.380  0.332
 [4,]  1.494  1.494  1.494 -1.089  1.312  0.340  0.340  0.340 -0.248  0.298
 [5,]  0.917  0.917  0.000 -0.573  0.754 -0.886 -0.886  0.000  0.554 -0.728
 [6,] -0.061 -0.061 -0.061  0.103 -0.042  0.065  0.065  0.065 -0.109  0.045
 [7,]  0.071  0.071  0.071  0.060  0.039 -0.320 -0.320 -0.320 -0.268 -0.177
 [8,]  0.225  0.000  0.000  0.034 -0.014 -0.418  0.000  0.000 -0.064  0.026
 [9,] -0.122  0.000 -0.122  0.139  0.037  0.075  0.000  0.075 -0.086 -0.023
[10,]  0.005  0.000  0.000  0.006 -0.002 -0.136  0.000  0.000 -0.171  0.052
       b_3_0  b_3_1  b_3_2 b_3_3  b_3_4  R_1_2  R_1_3  R_2_3
 [1,] -0.314  0.000 -0.314 0.335 -0.134 -0.009  0.032 -0.162
 [2,] -0.241  0.000 -0.241 0.052  0.071 -0.211  0.243 -0.133
 [3,] -0.288 -0.288 -0.288 0.296 -0.258 -0.049  0.118 -0.129
 [4,] -0.791 -0.791 -0.791 0.577 -0.695  0.593 -0.947 -0.320
 [5,] -1.245 -1.245  0.000 0.778 -1.023 -0.696 -0.902  1.016
 [6,] -0.070 -0.070 -0.070 0.119 -0.048 -0.002  0.015 -0.007
 [7,]  0.344  0.344  0.344 0.288  0.190 -0.012  0.055 -0.129
 [8,]  0.391  0.000  0.000 0.060 -0.024 -0.062  0.160 -0.192
 [9,] -0.067  0.000 -0.067 0.076  0.020 -0.004  0.025 -0.008
[10,]  0.153  0.000  0.000 0.191 -0.058  0.000  0.003 -0.027
> logLikValGrad1A <- mvProbitLogLik( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = allCoef, data = as.data.frame( cbind( xMat, yMat ) ),
+    oneSidedGrad = TRUE, algorithm = GenzBretz() )
> all.equal( logLikValGrad1, logLikValGrad1A )
[1] TRUE
> 
> # calculating log likelihood value(s) with two-sided gradients
> logLikValGrad <- mvProbitLogLik( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    returnGrad = TRUE, algorithm = GenzBretz() )
> round( c( logLikValGrad ), 3 )
 [1] -0.535 -0.942 -0.552 -2.327 -2.259 -0.086 -0.466 -0.704 -0.124 -0.149
> round( attr( logLikValGrad, "gradient" ), 3 )
       b_1_0  b_1_1  b_1_2  b_1_3  b_1_4  b_2_0  b_2_1  b_2_2  b_2_3  b_2_4
 [1,] -0.039  0.000 -0.039  0.042 -0.017  0.447  0.000  0.447 -0.477  0.191
 [2,] -0.620  0.000 -0.620  0.135  0.183  0.438  0.000  0.438 -0.096 -0.129
 [3,] -0.209 -0.209 -0.209  0.214 -0.187  0.371  0.371  0.371 -0.380  0.332
 [4,]  1.494  1.494  1.494 -1.089  1.312  0.340  0.340  0.340 -0.248  0.298
 [5,]  0.917  0.917  0.000 -0.573  0.754 -0.886 -0.886  0.000  0.554 -0.728
 [6,] -0.061 -0.061 -0.061  0.103 -0.042  0.065  0.065  0.065 -0.109  0.045
 [7,]  0.071  0.071  0.071  0.060  0.039 -0.320 -0.320 -0.320 -0.268 -0.177
 [8,]  0.225  0.000  0.000  0.034 -0.014 -0.418  0.000  0.000 -0.064  0.026
 [9,] -0.122  0.000 -0.122  0.139  0.037  0.075  0.000  0.075 -0.086 -0.023
[10,]  0.005  0.000  0.000  0.006 -0.002 -0.136  0.000  0.000 -0.171  0.052
       b_3_0  b_3_1  b_3_2 b_3_3  b_3_4  R_1_2  R_1_3  R_2_3
 [1,] -0.314  0.000 -0.314 0.335 -0.134 -0.009  0.032 -0.162
 [2,] -0.241  0.000 -0.241 0.052  0.071 -0.211  0.243 -0.133
 [3,] -0.288 -0.288 -0.288 0.296 -0.258 -0.049  0.118 -0.129
 [4,] -0.791 -0.791 -0.791 0.577 -0.695  0.593 -0.947 -0.320
 [5,] -1.245 -1.245  0.000 0.778 -1.023 -0.696 -0.902  1.016
 [6,] -0.070 -0.070 -0.070 0.119 -0.048 -0.002  0.015 -0.007
 [7,]  0.344  0.344  0.344 0.288  0.190 -0.012  0.055 -0.129
 [8,]  0.391  0.000  0.000 0.060 -0.024 -0.062  0.160 -0.192
 [9,] -0.067  0.000 -0.067 0.076  0.020 -0.004  0.025 -0.008
[10,]  0.153  0.000  0.000 0.191 -0.058  0.000  0.003 -0.027
> # now manually
> llTmp <- function( coef ) {
+    betaTmp <- coef[ 1:15 ]
+    sigmaTmp <- diag( 3 )
+    sigmaTmp[ lower.tri( sigmaTmp ) ] <- coef[ -(1:15) ]
+    sigmaTmp[ upper.tri( sigmaTmp ) ] <- t( sigmaTmp )[ upper.tri( sigmaTmp ) ]
+    result <- mvProbitLogLik( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+       coef = betaTmp, sigma = sigmaTmp, 
+       data = as.data.frame( cbind( xMat, yMat ) ), algorithm = GenzBretz() )
+    return( result )
+ }
> logLikValGrad2 <- numericGradient( llTmp, allCoef )
> round( logLikValGrad2, 3 )
        [,1]   [,2]   [,3]   [,4]   [,5]   [,6]   [,7]   [,8]   [,9]  [,10]
 [1,] -0.039  0.000 -0.039  0.042 -0.017  0.447  0.000  0.447 -0.477  0.191
 [2,] -0.620  0.000 -0.620  0.135  0.183  0.438  0.000  0.438 -0.096 -0.129
 [3,] -0.209 -0.209 -0.209  0.214 -0.187  0.371  0.371  0.371 -0.380  0.332
 [4,]  1.494  1.494  1.494 -1.089  1.312  0.340  0.340  0.340 -0.248  0.298
 [5,]  0.917  0.917  0.000 -0.573  0.754 -0.886 -0.886  0.000  0.554 -0.728
 [6,] -0.061 -0.061 -0.061  0.103 -0.042  0.065  0.065  0.065 -0.109  0.045
 [7,]  0.071  0.071  0.071  0.060  0.039 -0.320 -0.320 -0.320 -0.268 -0.177
 [8,]  0.225  0.000  0.000  0.034 -0.014 -0.418  0.000  0.000 -0.064  0.026
 [9,] -0.122  0.000 -0.122  0.139  0.037  0.075  0.000  0.075 -0.086 -0.023
[10,]  0.005  0.000  0.000  0.006 -0.002 -0.136  0.000  0.000 -0.171  0.052
       [,11]  [,12]  [,13] [,14]  [,15]  [,16]  [,17]  [,18]
 [1,] -0.314  0.000 -0.314 0.335 -0.134 -0.009  0.032 -0.162
 [2,] -0.241  0.000 -0.241 0.052  0.071 -0.211  0.243 -0.133
 [3,] -0.288 -0.288 -0.288 0.296 -0.258 -0.049  0.118 -0.129
 [4,] -0.791 -0.791 -0.791 0.577 -0.695  0.593 -0.947 -0.320
 [5,] -1.245 -1.245  0.000 0.778 -1.023 -0.696 -0.902  1.016
 [6,] -0.070 -0.070 -0.070 0.119 -0.048 -0.002  0.015 -0.007
 [7,]  0.344  0.344  0.344 0.288  0.190 -0.012  0.055 -0.129
 [8,]  0.391  0.000  0.000 0.060 -0.024 -0.062  0.160 -0.192
 [9,] -0.067  0.000 -0.067 0.076  0.020 -0.004  0.025 -0.008
[10,]  0.153  0.000  0.000 0.191 -0.058  0.000  0.003 -0.027
> # attr( logLikValGrad1, "gradient" ) / logLikValGrad2 - 1
> range( attr( logLikValGrad1, "gradient" ) / logLikValGrad2 - 1, na.rm = TRUE )
[1] -2.454e-06  1.182e-06
> # attr( logLikValGrad1, "gradient" ) - logLikValGrad2
> range( attr( logLikValGrad1, "gradient" ) - logLikValGrad2 )
[1] -7.794e-07  3.241e-07
> # attr( logLikValGrad1, "gradient" ) / logLikValGrad2 - 1
> range( attr( logLikValGrad, "gradient" ) / logLikValGrad2 - 1, na.rm = TRUE )
[1] -9.387e-08  2.260e-08
> # attr( logLikValGrad, "gradient" ) - logLikValGrad2
> range( attr( logLikValGrad, "gradient" ) - logLikValGrad2 )
[1] -5.907e-10  4.705e-10
> 
> # for testing state of random number generator
> rnorm( 4 )
[1] -1.3162  0.7625  0.9036  1.6774
> 
> # calculating marginal effects, unconditional
> margEffUnc <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), vcov = diag( 18 ) )
> round( margEffUnc, 3 )
   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.181     0.220    -0.122    -0.129     0.226    -0.241     0.070
2      0.430     0.190    -0.132    -0.374     0.215    -0.249     0.539
3      0.115     0.368    -0.203    -0.315     0.209    -0.242     0.287
4      0.208     0.383    -0.229    -0.374     0.233    -0.269     0.430
5      0.448     0.313    -0.209    -0.383     0.234    -0.271     0.501
6      0.027     0.151    -0.076    -0.153     0.066    -0.096     0.090
7      0.256     0.157    -0.133    -0.039     0.118    -0.147     0.125
8      0.132     0.377    -0.226    -0.331     0.219    -0.266     0.317
9      0.303     0.030    -0.027    -0.231     0.073    -0.097     0.168
10     0.002     0.243    -0.128    -0.029     0.118    -0.158     0.009
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.400     0.302    -0.040    -0.533     0.330
2     -0.366     0.320    -0.308    -0.488     0.349
3     -0.348     0.305    -0.164    -0.464     0.332
4     -0.429     0.378    -0.246    -0.572     0.412
5     -0.472     0.430    -0.286    -0.630     0.469
6     -0.075     0.082    -0.051    -0.101     0.090
7     -0.322     0.322    -0.071    -0.429     0.351
8     -0.379     0.368    -0.181    -0.505     0.401
9     -0.086     0.084    -0.096    -0.114     0.092
10    -0.156     0.160    -0.005    -0.209     0.174
> round( attr( margEffUnc, "vcov" )[ 1:3, , ], 3 )
, , d_y1_d_x1

  d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     0.256         0         0    -0.087         0         0     0.097
2     0.101         0         0    -0.060         0         0    -0.028
3     0.167         0         0    -0.099         0         0     0.260
  d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1         0         0    -0.058         0         0
2         0         0     0.037         0         0
3         0         0    -0.137         0         0

, , d_y2_d_x1

  d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1         0     0.177         0         0    -0.040         0         0
2         0     0.108         0         0    -0.044         0         0
3         0     0.123         0         0    -0.029         0         0
  d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1    -0.098         0         0    -0.268         0
2    -0.109         0         0    -0.146         0
3     0.002         0         0    -0.063         0

, , d_y3_d_x1

  d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1         0         0     0.082         0         0     0.000         0
2         0         0     0.065         0         0    -0.024         0
3         0         0     0.123         0         0    -0.026         0
  d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1         0    -0.079         0         0    -0.147
2         0    -0.067         0         0    -0.071
3         0    -0.007         0         0    -0.068

, , d_y1_d_x2

  d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1    -0.087         0         0     0.080         0         0    -0.044
2    -0.060         0         0     0.155         0         0     0.062
3    -0.099         0         0     0.180         0         0    -0.133
  d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1         0         0     0.027         0         0
2         0         0    -0.048         0         0
3         0         0     0.064         0         0

, , d_y2_d_x2

  d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1         0    -0.040         0         0     0.121         0         0
2         0    -0.044         0         0     0.102         0         0
3         0    -0.029         0         0     0.124         0         0
  d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     0.067         0         0     0.049         0
2     0.060         0         0     0.080         0
3     0.002         0         0    -0.063         0

, , d_y3_d_x2

  d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1         0         0     0.000         0         0     0.108         0
2         0         0    -0.024         0         0     0.098         0
3         0         0    -0.026         0         0     0.130         0
  d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1         0     0.035         0         0    -0.014
2         0     0.050         0         0     0.056
3         0    -0.012         0         0    -0.079

, , d_y1_d_x3

  d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     0.097         0         0    -0.044         0         0     0.055
2    -0.028         0         0     0.062         0         0     0.169
3     0.260         0         0    -0.133         0         0     0.435
  d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1         0         0    -0.031         0         0
2         0         0    -0.035         0         0
3         0         0    -0.204         0         0

, , d_y2_d_x3

  d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1         0    -0.098         0         0     0.067         0         0
2         0    -0.109         0         0     0.060         0         0
3         0     0.002         0         0     0.002         0         0
  d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     0.131         0         0     0.175         0
2     0.211         0         0     0.157         0
3     0.294         0         0     0.462         0

, , d_y3_d_x3

  d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1         0         0    -0.079         0         0     0.035         0
2         0         0    -0.067         0         0     0.050         0
3         0         0    -0.007         0         0    -0.012         0
  d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1         0     0.149         0         0     0.194
2         0     0.190         0         0     0.111
3         0     0.257         0         0     0.342

, , d_y1_d_x4

  d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1    -0.058         0         0     0.027         0         0    -0.031
2     0.037         0         0    -0.048         0         0    -0.035
3    -0.137         0         0     0.064         0         0    -0.204
  d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1         0         0     0.021         0         0
2         0         0     0.182         0         0
3         0         0     0.147         0         0

, , d_y2_d_x4

  d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1         0    -0.268         0         0     0.049         0         0
2         0    -0.146         0         0     0.080         0         0
3         0    -0.063         0         0    -0.063         0         0
  d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     0.175         0         0     0.541         0
2     0.157         0         0     0.302         0
3     0.462         0         0     0.944         0

, , d_y3_d_x4

  d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1         0         0    -0.147         0         0    -0.014         0
2         0         0    -0.071         0         0     0.056         0
3         0         0    -0.068         0         0    -0.079         0
  d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1         0     0.194         0         0     0.412
2         0     0.111         0         0     0.201
3         0     0.342         0         0     0.609

> round( drop( attr( margEffUnc, "vcov" )[ nObs, , ] ), 3 )
          d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
d_y1_d_x1     0.000     0.000     0.000    -0.001     0.000     0.000     0.000
d_y2_d_x1     0.000     0.259     0.000     0.000     0.083     0.000     0.000
d_y3_d_x1     0.000     0.000     0.134     0.000     0.000     0.061     0.000
d_y1_d_x2    -0.001     0.000     0.000     0.016     0.000     0.000    -0.004
d_y2_d_x2     0.000     0.083     0.000     0.000     0.122     0.000     0.000
d_y3_d_x2     0.000     0.000     0.061     0.000     0.000     0.166     0.000
d_y1_d_x3     0.000     0.000     0.000    -0.004     0.000     0.000     0.002
d_y2_d_x3     0.000    -0.105     0.000     0.000    -0.065     0.000     0.000
d_y3_d_x3     0.000     0.000    -0.061     0.000     0.000    -0.071     0.000
d_y1_d_x4     0.000     0.000     0.000     0.003     0.000     0.000    -0.001
d_y2_d_x4     0.000    -0.200     0.000     0.000    -0.123     0.000     0.000
d_y3_d_x4     0.000     0.000    -0.101     0.000     0.000    -0.118     0.000
          d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
d_y1_d_x1     0.000     0.000     0.000     0.000     0.000
d_y2_d_x1    -0.105     0.000     0.000    -0.200     0.000
d_y3_d_x1     0.000    -0.061     0.000     0.000    -0.101
d_y1_d_x2     0.000     0.000     0.003     0.000     0.000
d_y2_d_x2    -0.065     0.000     0.000    -0.123     0.000
d_y3_d_x2     0.000    -0.071     0.000     0.000    -0.118
d_y1_d_x3     0.000     0.000    -0.001     0.000     0.000
d_y2_d_x3     0.089     0.000     0.000     0.159     0.000
d_y3_d_x3     0.000     0.078     0.000     0.000     0.120
d_y1_d_x4     0.000     0.000     0.001     0.000     0.000
d_y2_d_x4     0.159     0.000     0.000     0.312     0.000
d_y3_d_x4     0.000     0.120     0.000     0.000     0.215
> print( summary( margEffUnc ), digits = 3 )
              Estimate Std. error z value Pr(> z)  
1: d_y1_d_x1   0.18067    0.50643    0.36    0.72  
1: d_y2_d_x1   0.21967    0.42018    0.52    0.60  
1: d_y3_d_x1  -0.12236    0.28650   -0.43    0.67  
1: d_y1_d_x2  -0.12920    0.28340   -0.46    0.65  
1: d_y2_d_x2   0.22581    0.34805    0.65    0.52  
1: d_y3_d_x2  -0.24121    0.32914   -0.73    0.46  
1: d_y1_d_x3   0.07027    0.23489    0.30    0.76  
1: d_y2_d_x3  -0.40010    0.36246   -1.10    0.27  
1: d_y3_d_x3   0.30244    0.38548    0.78    0.43  
1: d_y1_d_x4  -0.04016    0.14567   -0.28    0.78  
1: d_y2_d_x4  -0.53346    0.73555   -0.73    0.47  
1: d_y3_d_x4   0.32993    0.64150    0.51    0.61  
2: d_y1_d_x1   0.43012    0.31756    1.35    0.18  
2: d_y2_d_x1   0.19008    0.32788    0.58    0.56  
2: d_y3_d_x1  -0.13196    0.25436   -0.52    0.60  
2: d_y1_d_x2  -0.37365    0.39392   -0.95    0.34  
2: d_y2_d_x2   0.21526    0.31971    0.67    0.50  
2: d_y3_d_x2  -0.24897    0.31227   -0.80    0.43  
2: d_y1_d_x3   0.53866    0.41054    1.31    0.19  
2: d_y2_d_x3  -0.36577    0.45942   -0.80    0.43  
2: d_y3_d_x3   0.32022    0.43634    0.73    0.46  
2: d_y1_d_x4  -0.30780    0.42604   -0.72    0.47  
2: d_y2_d_x4  -0.48769    0.54958   -0.89    0.37  
2: d_y3_d_x4   0.34934    0.44860    0.78    0.44  
3: d_y1_d_x1   0.11523    0.40916    0.28    0.78  
3: d_y2_d_x1   0.36751    0.35129    1.05    0.30  
3: d_y3_d_x1  -0.20315    0.35033   -0.58    0.56  
3: d_y1_d_x2  -0.31484    0.42404   -0.74    0.46  
3: d_y2_d_x2   0.20899    0.35146    0.59    0.55  
3: d_y3_d_x2  -0.24220    0.36014   -0.67    0.50  
3: d_y1_d_x3   0.28748    0.65986    0.44    0.66  
3: d_y2_d_x3  -0.34791    0.54204   -0.64    0.52  
3: d_y3_d_x3   0.30462    0.50740    0.60    0.55  
3: d_y1_d_x4  -0.16427    0.38284   -0.43    0.67  
3: d_y2_d_x4  -0.46388    0.97135   -0.48    0.63  
3: d_y3_d_x4   0.33232    0.78015    0.43    0.67  
4: d_y1_d_x1   0.20761    0.54002    0.38    0.70  
4: d_y2_d_x1   0.38276    0.35781    1.07    0.28  
4: d_y3_d_x1  -0.22889    0.35761   -0.64    0.52  
4: d_y1_d_x2  -0.37427    0.33736   -1.11    0.27  
4: d_y2_d_x2   0.23255    0.36399    0.64    0.52  
4: d_y3_d_x2  -0.26856    0.35563   -0.76    0.45  
4: d_y1_d_x3   0.43007    0.60913    0.71    0.48  
4: d_y2_d_x3  -0.42874    0.44367   -0.97    0.33  
4: d_y3_d_x3   0.37765    0.44565    0.85    0.40  
4: d_y1_d_x4  -0.24576    0.36651   -0.67    0.50  
4: d_y2_d_x4  -0.57165    0.77847   -0.73    0.46  
4: d_y3_d_x4   0.41198    0.68801    0.60    0.55  
5: d_y1_d_x1   0.44801    0.36549    1.23    0.22  
5: d_y2_d_x1   0.31256    0.47992    0.65    0.51  
5: d_y3_d_x1  -0.20905    0.41729   -0.50    0.62  
5: d_y1_d_x2  -0.38274    0.34681   -1.10    0.27  
5: d_y2_d_x2   0.23373    0.36682    0.64    0.52  
5: d_y3_d_x2  -0.27066    0.35847   -0.76    0.45  
5: d_y1_d_x3   0.50066    0.63315    0.79    0.43  
5: d_y2_d_x3  -0.47230    0.46016   -1.03    0.30  
5: d_y3_d_x3   0.43029    0.46593    0.92    0.36  
5: d_y1_d_x4  -0.28609    0.51135   -0.56    0.58  
5: d_y2_d_x4  -0.62973    0.34775   -1.81    0.07 .
5: d_y3_d_x4   0.46941    0.34620    1.36    0.18  
6: d_y1_d_x1   0.02699    0.15450    0.17    0.86  
6: d_y2_d_x1   0.15092    0.46066    0.33    0.74  
6: d_y3_d_x1  -0.07584    0.27020   -0.28    0.78  
6: d_y1_d_x2  -0.15289    0.46351   -0.33    0.74  
6: d_y2_d_x2   0.06576    0.24699    0.27    0.79  
6: d_y3_d_x2  -0.09575    0.32253   -0.30    0.77  
6: d_y1_d_x3   0.08974    0.39125    0.23    0.82  
6: d_y2_d_x3  -0.07547    0.32599   -0.23    0.82  
6: d_y3_d_x3   0.08239    0.33324    0.25    0.80  
6: d_y1_d_x4  -0.05128    0.23709   -0.22    0.83  
6: d_y2_d_x4  -0.10062    0.50725   -0.20    0.84  
6: d_y3_d_x4   0.08988    0.43974    0.20    0.84  
7: d_y1_d_x1   0.25630    0.45523    0.56    0.57  
7: d_y2_d_x1   0.15703    0.44039    0.36    0.72  
7: d_y3_d_x1  -0.13302    0.38072   -0.35    0.73  
7: d_y1_d_x2  -0.03867    0.16470   -0.23    0.81  
7: d_y2_d_x2   0.11840    0.35818    0.33    0.74  
7: d_y3_d_x2  -0.14725    0.40427   -0.36    0.72  
7: d_y1_d_x3   0.12512    0.40398    0.31    0.76  
7: d_y2_d_x3  -0.32171    0.52222   -0.62    0.54  
7: d_y3_d_x3   0.32215    0.46782    0.69    0.49  
7: d_y1_d_x4  -0.07149    0.28547   -0.25    0.80  
7: d_y2_d_x4  -0.42895    0.73789   -0.58    0.56  
7: d_y3_d_x4   0.35144    0.54987    0.64    0.52  
8: d_y1_d_x1   0.13183    0.20074    0.66    0.51  
8: d_y2_d_x1   0.37695    0.38515    0.98    0.33  
8: d_y3_d_x1  -0.22611    0.40427   -0.56    0.58  
8: d_y1_d_x2  -0.33078    0.43449   -0.76    0.45  
8: d_y2_d_x2   0.21946    0.40610    0.54    0.59  
8: d_y3_d_x2  -0.26593    0.40173   -0.66    0.51  
8: d_y1_d_x3   0.31702    0.38062    0.83    0.40  
8: d_y2_d_x3  -0.37862    0.37883   -1.00    0.32  
8: d_y3_d_x3   0.36777    0.37230    0.99    0.32  
8: d_y1_d_x4  -0.18116    0.28998   -0.62    0.53  
8: d_y2_d_x4  -0.50483    0.48571   -1.04    0.30  
8: d_y3_d_x4   0.40121    0.42452    0.95    0.34  
9: d_y1_d_x1   0.30295    0.60131    0.50    0.61  
9: d_y2_d_x1   0.02963    0.11910    0.25    0.80  
9: d_y3_d_x1  -0.02667    0.10327   -0.26    0.80  
9: d_y1_d_x2  -0.23090    0.36496   -0.63    0.53  
9: d_y2_d_x2   0.07291    0.18450    0.40    0.69  
9: d_y3_d_x2  -0.09710    0.22509   -0.43    0.67  
9: d_y1_d_x3   0.16837    0.41649    0.40    0.69  
9: d_y2_d_x3  -0.08563    0.25466   -0.34    0.74  
9: d_y3_d_x3   0.08389    0.24136    0.35    0.73  
9: d_y1_d_x4  -0.09621    0.31727   -0.30    0.76  
9: d_y2_d_x4  -0.11418    0.38467   -0.30    0.77  
9: d_y3_d_x4   0.09152    0.30328    0.30    0.76  
10: d_y1_d_x1  0.00210    0.01085    0.19    0.85  
10: d_y2_d_x1  0.24266    0.50885    0.48    0.63  
10: d_y3_d_x1 -0.12794    0.36564   -0.35    0.73  
10: d_y1_d_x2 -0.02934    0.12716   -0.23    0.82  
10: d_y2_d_x2  0.11782    0.34949    0.34    0.74  
10: d_y3_d_x2 -0.15753    0.40735   -0.39    0.70  
10: d_y1_d_x3  0.00936    0.03928    0.24    0.81  
10: d_y2_d_x3 -0.15640    0.29876   -0.52    0.60  
10: d_y3_d_x3  0.15952    0.28002    0.57    0.57  
10: d_y1_d_x4 -0.00535    0.02454   -0.22    0.83  
10: d_y2_d_x4 -0.20853    0.55887   -0.37    0.71  
10: d_y3_d_x4  0.17402    0.46353    0.38    0.71  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> margEffUncA <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = allCoef,
+    data = as.data.frame( xMat ), vcov = diag( 18 ) )
> all.equal( margEffUnc, margEffUncA )
[1] TRUE
> # now with explicitly specifying dummy variables
> margEffUncD <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), vcov = diag( 18 ),
+    dummyVar = c( "x1", "x2" ) )
> all.equal( margEffUncD, margEffUnc )
[1] TRUE
> # now with seemingly no dummy variables
> margEffUncD0 <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), vcov = diag( 18 ),
+    dummyVar = NULL )
> print( summary( margEffUncD0 ), digits = 3 )
              Estimate Std. error z value Pr(> z)  
1: d_y1_d_x1   0.06023    0.22907    0.26    0.79  
1: d_y2_d_x1   0.33342    0.49355    0.68    0.50  
1: d_y3_d_x1  -0.16497    0.37800   -0.44    0.66  
1: d_y1_d_x2  -0.05019    0.16417   -0.31    0.76  
1: d_y2_d_x2   0.20005    0.28094    0.71    0.48  
1: d_y3_d_x2  -0.19246    0.27544   -0.70    0.48  
1: d_y1_d_x3   0.07027    0.23489    0.30    0.76  
1: d_y2_d_x3  -0.40010    0.36246   -1.10    0.27  
1: d_y3_d_x3   0.30244    0.38548    0.78    0.43  
1: d_y1_d_x4  -0.04016    0.14567   -0.28    0.78  
1: d_y2_d_x4  -0.53346    0.73555   -0.73    0.47  
1: d_y3_d_x4   0.32993    0.64150    0.51    0.61  
2: d_y1_d_x1   0.46171    0.42543    1.09    0.28  
2: d_y2_d_x1   0.30480    0.44690    0.68    0.50  
2: d_y3_d_x1  -0.17467    0.35464   -0.49    0.62  
2: d_y1_d_x2  -0.38476    0.30208   -1.27    0.20  
2: d_y2_d_x2   0.18288    0.22256    0.82    0.41  
2: d_y3_d_x2  -0.20378    0.21544   -0.95    0.34  
2: d_y1_d_x3   0.53866    0.41054    1.31    0.19  
2: d_y2_d_x3  -0.36577    0.45942   -0.80    0.43  
2: d_y3_d_x3   0.32022    0.43634    0.73    0.46  
2: d_y1_d_x4  -0.30780    0.42604   -0.72    0.47  
2: d_y2_d_x4  -0.48769    0.54958   -0.89    0.37  
2: d_y3_d_x4   0.34934    0.44860    0.78    0.44  
3: d_y1_d_x1   0.24641    0.74181    0.33    0.74  
3: d_y2_d_x1   0.28992    0.45863    0.63    0.53  
3: d_y3_d_x1  -0.16616    0.30965   -0.54    0.59  
3: d_y1_d_x2  -0.20534    0.46566   -0.44    0.66  
3: d_y2_d_x2   0.17395    0.31185    0.56    0.58  
3: d_y3_d_x2  -0.19385    0.34366   -0.56    0.57  
3: d_y1_d_x3   0.28748    0.65986    0.44    0.66  
3: d_y2_d_x3  -0.34791    0.54204   -0.64    0.52  
3: d_y3_d_x3   0.30462    0.50740    0.60    0.55  
3: d_y1_d_x4  -0.16427    0.38284   -0.43    0.67  
3: d_y2_d_x4  -0.46388    0.97135   -0.48    0.63  
3: d_y3_d_x4   0.33232    0.78015    0.43    0.67  
4: d_y1_d_x1   0.36863    0.75078    0.49    0.62  
4: d_y2_d_x1   0.35728    0.35903    1.00    0.32  
4: d_y3_d_x1  -0.20599    0.30852   -0.67    0.50  
4: d_y1_d_x2  -0.30720    0.41247   -0.74    0.46  
4: d_y2_d_x2   0.21437    0.31523    0.68    0.50  
4: d_y3_d_x2  -0.24032    0.31948   -0.75    0.45  
4: d_y1_d_x3   0.43007    0.60913    0.71    0.48  
4: d_y2_d_x3  -0.42874    0.44367   -0.97    0.33  
4: d_y3_d_x3   0.37765    0.44565    0.85    0.40  
4: d_y1_d_x4  -0.24576    0.36651   -0.67    0.50  
4: d_y2_d_x4  -0.57165    0.77847   -0.73    0.46  
4: d_y3_d_x4   0.41198    0.68801    0.60    0.55  
5: d_y1_d_x1   0.42914    0.32836    1.31    0.19  
5: d_y2_d_x1   0.39358    0.46780    0.84    0.40  
5: d_y3_d_x1  -0.23470    0.44281   -0.53    0.60  
5: d_y1_d_x2  -0.35761    0.46232   -0.77    0.44  
5: d_y2_d_x2   0.23615    0.39943    0.59    0.55  
5: d_y3_d_x2  -0.27382    0.40256   -0.68    0.50  
5: d_y1_d_x3   0.50066    0.63315    0.79    0.43  
5: d_y2_d_x3  -0.47230    0.46016   -1.03    0.30  
5: d_y3_d_x3   0.43029    0.46593    0.92    0.36  
5: d_y1_d_x4  -0.28609    0.51135   -0.56    0.58  
5: d_y2_d_x4  -0.62973    0.34775   -1.81    0.07 .
5: d_y3_d_x4   0.46941    0.34620    1.36    0.18  
6: d_y1_d_x1   0.07692    0.39959    0.19    0.85  
6: d_y2_d_x1   0.06289    0.28487    0.22    0.83  
6: d_y3_d_x1  -0.04494    0.18973   -0.24    0.81  
6: d_y1_d_x2  -0.06410    0.28867   -0.22    0.82  
6: d_y2_d_x2   0.03773    0.16761    0.23    0.82  
6: d_y3_d_x2  -0.05243    0.22218   -0.24    0.81  
6: d_y1_d_x3   0.08974    0.39125    0.23    0.82  
6: d_y2_d_x3  -0.07547    0.32599   -0.23    0.82  
6: d_y3_d_x3   0.08239    0.33324    0.25    0.80  
6: d_y1_d_x4  -0.05128    0.23709   -0.22    0.83  
6: d_y2_d_x4  -0.10062    0.50725   -0.20    0.84  
6: d_y3_d_x4   0.08988    0.43974    0.20    0.84  
7: d_y1_d_x1   0.10724    0.33569    0.32    0.75  
7: d_y2_d_x1   0.26809    0.65496    0.41    0.68  
7: d_y3_d_x1  -0.17572    0.49325   -0.36    0.72  
7: d_y1_d_x2  -0.08937    0.36241   -0.25    0.81  
7: d_y2_d_x2   0.16086    0.48081    0.33    0.74  
7: d_y3_d_x2  -0.20500    0.53332   -0.38    0.70  
7: d_y1_d_x3   0.12512    0.40398    0.31    0.76  
7: d_y2_d_x3  -0.32171    0.52222   -0.62    0.54  
7: d_y3_d_x3   0.32215    0.46782    0.69    0.49  
7: d_y1_d_x4  -0.07149    0.28547   -0.25    0.80  
7: d_y2_d_x4  -0.42895    0.73789   -0.58    0.56  
7: d_y3_d_x4   0.35144    0.54987    0.64    0.52  
8: d_y1_d_x1   0.27173    0.37056    0.73    0.46  
8: d_y2_d_x1   0.31552    0.38408    0.82    0.41  
8: d_y3_d_x1  -0.20060    0.35555   -0.56    0.57  
8: d_y1_d_x2  -0.22644    0.33321   -0.68    0.50  
8: d_y2_d_x2   0.18931    0.34179    0.55    0.58  
8: d_y3_d_x2  -0.23404    0.36291   -0.64    0.52  
8: d_y1_d_x3   0.31702    0.38062    0.83    0.40  
8: d_y2_d_x3  -0.37862    0.37883   -1.00    0.32  
8: d_y3_d_x3   0.36777    0.37230    0.99    0.32  
8: d_y1_d_x4  -0.18116    0.28998   -0.62    0.53  
8: d_y2_d_x4  -0.50483    0.48571   -1.04    0.30  
8: d_y3_d_x4   0.40121    0.42452    0.95    0.34  
9: d_y1_d_x1   0.14432    0.42864    0.34    0.74  
9: d_y2_d_x1   0.07136    0.25399    0.28    0.78  
9: d_y3_d_x1  -0.04576    0.17117   -0.27    0.79  
9: d_y1_d_x2  -0.12027    0.29534   -0.41    0.68  
9: d_y2_d_x2   0.04282    0.12305    0.35    0.73  
9: d_y3_d_x2  -0.05339    0.15155   -0.35    0.72  
9: d_y1_d_x3   0.16837    0.41649    0.40    0.69  
9: d_y2_d_x3  -0.08563    0.25466   -0.34    0.74  
9: d_y3_d_x3   0.08389    0.24136    0.35    0.73  
9: d_y1_d_x4  -0.09621    0.31727   -0.30    0.76  
9: d_y2_d_x4  -0.11418    0.38467   -0.30    0.77  
9: d_y3_d_x4   0.09152    0.30328    0.30    0.76  
10: d_y1_d_x1  0.00802    0.03841    0.21    0.83  
10: d_y2_d_x1  0.13033    0.34680    0.38    0.71  
10: d_y3_d_x1 -0.08701    0.25031   -0.35    0.73  
10: d_y1_d_x2 -0.00668    0.03222   -0.21    0.84  
10: d_y2_d_x2  0.07820    0.23274    0.34    0.74  
10: d_y3_d_x2 -0.10151    0.27873   -0.36    0.72  
10: d_y1_d_x3  0.00936    0.03928    0.24    0.81  
10: d_y2_d_x3 -0.15640    0.29876   -0.52    0.60  
10: d_y3_d_x3  0.15952    0.28002    0.57    0.57  
10: d_y1_d_x4 -0.00535    0.02454   -0.22    0.83  
10: d_y2_d_x4 -0.20853    0.55887   -0.37    0.71  
10: d_y3_d_x4  0.17402    0.46353    0.38    0.71  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> # now with seemingly only dummy variables
> margEffUncDA <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), vcov = diag( 18 ),
+    dummyVar = c( "x1", "x2", "x3", "x4" ) )
> print( summary( margEffUncDA ), digits = 3 )
              Estimate Std. error z value Pr(> z)  
1: d_y1_d_x1    0.1807     0.5064    0.36   0.721  
1: d_y2_d_x1    0.2197     0.4202    0.52   0.601  
1: d_y3_d_x1   -0.1224     0.2865   -0.43   0.669  
1: d_y1_d_x2   -0.1292     0.2834   -0.46   0.648  
1: d_y2_d_x2    0.2258     0.3481    0.65   0.516  
1: d_y3_d_x2   -0.2412     0.3291   -0.73   0.464  
1: d_y1_d_x3    0.5106     0.2940    1.74   0.082 .
1: d_y2_d_x3   -0.2176     0.3729   -0.58   0.560  
1: d_y3_d_x3    0.2986     0.3740    0.80   0.425  
1: d_y1_d_x4   -0.0387     0.1378   -0.28   0.779  
1: d_y2_d_x4   -0.5250     0.5235   -1.00   0.316  
1: d_y3_d_x4    0.3461     0.5762    0.60   0.548  
2: d_y1_d_x1    0.4301     0.3176    1.35   0.176  
2: d_y2_d_x1    0.1901     0.3279    0.58   0.562  
2: d_y3_d_x1   -0.1320     0.2544   -0.52   0.604  
2: d_y1_d_x2   -0.3736     0.3939   -0.95   0.343  
2: d_y2_d_x2    0.2153     0.3197    0.67   0.501  
2: d_y3_d_x2   -0.2490     0.3123   -0.80   0.425  
2: d_y1_d_x3    0.4101     0.3968    1.03   0.301  
2: d_y2_d_x3   -0.4482     0.3148   -1.42   0.154  
2: d_y3_d_x3    0.4177     0.3437    1.22   0.224  
2: d_y1_d_x4   -0.2108     0.3098   -0.68   0.496  
2: d_y2_d_x4   -0.5128     0.3578   -1.43   0.152  
2: d_y3_d_x4    0.4464     0.3123    1.43   0.153  
3: d_y1_d_x1    0.1152     0.4092    0.28   0.778  
3: d_y2_d_x1    0.3675     0.3513    1.05   0.295  
3: d_y3_d_x1   -0.2031     0.3503   -0.58   0.562  
3: d_y1_d_x2   -0.3148     0.4240   -0.74   0.458  
3: d_y2_d_x2    0.2090     0.3515    0.59   0.552  
3: d_y3_d_x2   -0.2422     0.3601   -0.67   0.501  
3: d_y1_d_x3    0.3421     0.5670    0.60   0.546  
3: d_y2_d_x3   -0.2815     0.5141   -0.55   0.584  
3: d_y3_d_x3    0.3073     0.4727    0.65   0.516  
3: d_y1_d_x4   -0.2231     0.4017   -0.56   0.579  
3: d_y2_d_x4   -0.2511     0.6757   -0.37   0.710  
3: d_y3_d_x4    0.2062     0.5784    0.36   0.721  
4: d_y1_d_x1    0.2076     0.5400    0.38   0.701  
4: d_y2_d_x1    0.3828     0.3578    1.07   0.285  
4: d_y3_d_x1   -0.2289     0.3576   -0.64   0.522  
4: d_y1_d_x2   -0.3743     0.3374   -1.11   0.267  
4: d_y2_d_x2    0.2326     0.3640    0.64   0.523  
4: d_y3_d_x2   -0.2686     0.3556   -0.76   0.450  
4: d_y1_d_x3    0.3382     0.5657    0.60   0.550  
4: d_y2_d_x3   -0.2885     0.5120   -0.56   0.573  
4: d_y3_d_x3    0.3119     0.4683    0.67   0.505  
4: d_y1_d_x4   -0.2859     0.3564   -0.80   0.423  
4: d_y2_d_x4   -0.3614     0.7062   -0.51   0.609  
4: d_y3_d_x4    0.2893     0.6078    0.48   0.634  
5: d_y1_d_x1    0.4480     0.3655    1.23   0.220  
5: d_y2_d_x1    0.3126     0.4799    0.65   0.515  
5: d_y3_d_x1   -0.2091     0.4173   -0.50   0.616  
5: d_y1_d_x2   -0.3827     0.3468   -1.10   0.270  
5: d_y2_d_x2    0.2337     0.3668    0.64   0.524  
5: d_y3_d_x2   -0.2707     0.3585   -0.76   0.450  
5: d_y1_d_x3    0.0866     0.2499    0.35   0.729  
5: d_y2_d_x3   -0.1630     0.3623   -0.45   0.653  
5: d_y3_d_x3    0.1643     0.3543    0.46   0.643  
5: d_y1_d_x4   -0.2423     0.4577   -0.53   0.597  
5: d_y2_d_x4   -0.5486     0.4326   -1.27   0.205  
5: d_y3_d_x4    0.4445     0.3838    1.16   0.247  
6: d_y1_d_x1    0.0270     0.1545    0.17   0.861  
6: d_y2_d_x1    0.1509     0.4607    0.33   0.743  
6: d_y3_d_x1   -0.0758     0.2702   -0.28   0.779  
6: d_y1_d_x2   -0.1529     0.4635   -0.33   0.742  
6: d_y2_d_x2    0.0658     0.2470    0.27   0.790  
6: d_y3_d_x2   -0.0958     0.3225   -0.30   0.767  
6: d_y1_d_x3    0.2945     0.5425    0.54   0.587  
6: d_y2_d_x3   -0.3630     0.4545   -0.80   0.425  
6: d_y3_d_x3    0.3595     0.4081    0.88   0.378  
6: d_y1_d_x4   -0.0714     0.2911   -0.25   0.806  
6: d_y2_d_x4   -0.0760     0.3695   -0.21   0.837  
6: d_y3_d_x4    0.0688     0.3359    0.20   0.838  
7: d_y1_d_x1    0.2563     0.4552    0.56   0.573  
7: d_y2_d_x1    0.1570     0.4404    0.36   0.721  
7: d_y3_d_x1   -0.1330     0.3807   -0.35   0.727  
7: d_y1_d_x2   -0.0387     0.1647   -0.23   0.814  
7: d_y2_d_x2    0.1184     0.3582    0.33   0.741  
7: d_y3_d_x2   -0.1472     0.4043   -0.36   0.716  
7: d_y1_d_x3    0.2636     0.5177    0.51   0.611  
7: d_y2_d_x3   -0.4066     0.3879   -1.05   0.295  
7: d_y3_d_x3    0.3865     0.3634    1.06   0.288  
7: d_y1_d_x4   -0.0700     0.2749   -0.25   0.799  
7: d_y2_d_x4   -0.4437     0.5667   -0.78   0.434  
7: d_y3_d_x4    0.3585     0.4718    0.76   0.447  
8: d_y1_d_x1    0.1318     0.2007    0.66   0.511  
8: d_y2_d_x1    0.3770     0.3851    0.98   0.328  
8: d_y3_d_x1   -0.2261     0.4043   -0.56   0.576  
8: d_y1_d_x2   -0.3308     0.4345   -0.76   0.446  
8: d_y2_d_x2    0.2195     0.4061    0.54   0.589  
8: d_y3_d_x2   -0.2659     0.4017   -0.66   0.508  
8: d_y1_d_x3    0.1855     0.2488    0.75   0.456  
8: d_y2_d_x3   -0.2637     0.2750   -0.96   0.338  
8: d_y3_d_x3    0.2716     0.2706    1.00   0.316  
8: d_y1_d_x4   -0.2599     0.4189   -0.62   0.535  
8: d_y2_d_x4   -0.2079     0.2743   -0.76   0.448  
8: d_y3_d_x4    0.2210     0.2617    0.84   0.398  
9: d_y1_d_x1    0.3029     0.6013    0.50   0.614  
9: d_y2_d_x1    0.0296     0.1191    0.25   0.804  
9: d_y3_d_x1   -0.0267     0.1033   -0.26   0.796  
9: d_y1_d_x2   -0.2309     0.3650   -0.63   0.527  
9: d_y2_d_x2    0.0729     0.1845    0.40   0.693  
9: d_y3_d_x2   -0.0971     0.2251   -0.43   0.666  
9: d_y1_d_x3    0.4079     0.3989    1.02   0.307  
9: d_y2_d_x3   -0.4491     0.3164   -1.42   0.156  
9: d_y3_d_x3    0.4176     0.3463    1.21   0.228  
9: d_y1_d_x4   -0.0317     0.1207   -0.26   0.793  
9: d_y2_d_x4   -0.5066     0.5716   -0.89   0.375  
9: d_y3_d_x4    0.3273     0.5926    0.55   0.581  
10: d_y1_d_x1   0.0021     0.0109    0.19   0.847  
10: d_y2_d_x1   0.2427     0.5089    0.48   0.633  
10: d_y3_d_x1  -0.1279     0.3656   -0.35   0.726  
10: d_y1_d_x2  -0.0293     0.1272   -0.23   0.818  
10: d_y2_d_x2   0.1178     0.3495    0.34   0.736  
10: d_y3_d_x2  -0.1575     0.4073   -0.39   0.699  
10: d_y1_d_x3   0.1286     0.2141    0.60   0.548  
10: d_y2_d_x3  -0.3867     0.2925   -1.32   0.186  
10: d_y3_d_x3   0.3563     0.2913    1.22   0.221  
10: d_y1_d_x4  -0.0343     0.1414   -0.24   0.808  
10: d_y2_d_x4  -0.0176     0.0692   -0.25   0.800  
10: d_y3_d_x4   0.0291     0.1039    0.28   0.780  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> # now with mean values of the marginal effects
> margEffUncM <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), vcov = diag( 18 ), 
+    addMean = TRUE )
> all.equal( margEffUnc, margEffUncM[ 1:nObs, ], check.attributes = FALSE )
[1] TRUE
> round( margEffUncM[ nObs:(nObs+1), ], 3 )
     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
10       0.002     0.243    -0.128    -0.029     0.118    -0.158     0.009
mean     0.210     0.243    -0.148    -0.236     0.171    -0.204     0.254
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
10      -0.156     0.160    -0.005    -0.209     0.174
mean    -0.303     0.275    -0.145    -0.404     0.300
> all.equal( attr( margEffUnc, "vcov" ), 
+    attr( margEffUncM, "vcov" )[ 1:nObs, , ] )
[1] TRUE
> round( attr( margEffUncM, "vcov" )[ nObs:(nObs+1), , ], 3 )
, , d_y1_d_x1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
10       0.000         0         0    -0.001         0         0     0.000
mean     0.062         0         0    -0.015         0         0     0.013
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
10           0         0     0.000         0         0
mean         0         0    -0.014         0         0

, , d_y2_d_x1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
10           0     0.259         0         0     0.083         0         0
mean         0     0.070         0         0    -0.009         0         0
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
10      -0.105         0         0    -0.200         0
mean     0.009         0         0    -0.027         0

, , d_y3_d_x1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
10           0         0     0.134         0         0     0.061         0
mean         0         0     0.066         0         0    -0.007         0
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
10           0    -0.061         0         0    -0.101
mean         0     0.007         0         0    -0.017

, , d_y1_d_x2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
10      -0.001         0         0     0.016         0         0    -0.004
mean    -0.015         0         0     0.061         0         0     0.022
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
10           0         0     0.003         0         0
mean         0         0    -0.008         0         0

, , d_y2_d_x2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
10           0     0.083         0         0     0.122         0         0
mean         0    -0.009         0         0     0.082         0         0
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
10      -0.065         0         0    -0.123         0
mean     0.032         0         0     0.011         0

, , d_y3_d_x2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
10           0         0     0.061         0         0     0.166         0
mean         0         0    -0.007         0         0     0.085         0
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
10           0    -0.071         0         0    -0.118
mean         0     0.034         0         0     0.002

, , d_y1_d_x3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
10       0.000         0         0    -0.004         0         0     0.002
mean     0.013         0         0     0.022         0         0     0.020
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
10           0         0    -0.001         0         0
mean         0         0    -0.001         0         0

, , d_y2_d_x3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
10           0    -0.105         0         0    -0.065         0         0
mean         0     0.009         0         0     0.032         0         0
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
10       0.089         0         0     0.159         0
mean     0.021         0         0     0.010         0

, , d_y3_d_x3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
10           0         0    -0.061         0         0    -0.071         0
mean         0         0     0.007         0         0     0.034         0
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
10           0     0.078         0         0     0.120
mean         0     0.023         0         0     0.012

, , d_y1_d_x4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
10       0.000         0         0     0.003         0         0    -0.001
mean    -0.014         0         0    -0.008         0         0    -0.001
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
10           0         0     0.001         0         0
mean         0         0     0.039         0         0

, , d_y2_d_x4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
10           0    -0.200         0         0    -0.123         0         0
mean         0    -0.027         0         0     0.011         0         0
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
10       0.159         0         0     0.312         0
mean     0.010         0         0     0.166         0

, , d_y3_d_x4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
10           0         0    -0.101         0         0    -0.118         0
mean         0         0    -0.017         0         0     0.002         0
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
10           0     0.120         0         0     0.215
mean         0     0.012         0         0     0.135

> round( drop( attr( margEffUncM, "vcov" )[ nObs+1, , ] ), 3 )
          d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
d_y1_d_x1     0.062     0.000     0.000    -0.015     0.000     0.000     0.013
d_y2_d_x1     0.000     0.070     0.000     0.000    -0.009     0.000     0.000
d_y3_d_x1     0.000     0.000     0.066     0.000     0.000    -0.007     0.000
d_y1_d_x2    -0.015     0.000     0.000     0.061     0.000     0.000     0.022
d_y2_d_x2     0.000    -0.009     0.000     0.000     0.082     0.000     0.000
d_y3_d_x2     0.000     0.000    -0.007     0.000     0.000     0.085     0.000
d_y1_d_x3     0.013     0.000     0.000     0.022     0.000     0.000     0.020
d_y2_d_x3     0.000     0.009     0.000     0.000     0.032     0.000     0.000
d_y3_d_x3     0.000     0.000     0.007     0.000     0.000     0.034     0.000
d_y1_d_x4    -0.014     0.000     0.000    -0.008     0.000     0.000    -0.001
d_y2_d_x4     0.000    -0.027     0.000     0.000     0.011     0.000     0.000
d_y3_d_x4     0.000     0.000    -0.017     0.000     0.000     0.002     0.000
          d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
d_y1_d_x1     0.000     0.000    -0.014     0.000     0.000
d_y2_d_x1     0.009     0.000     0.000    -0.027     0.000
d_y3_d_x1     0.000     0.007     0.000     0.000    -0.017
d_y1_d_x2     0.000     0.000    -0.008     0.000     0.000
d_y2_d_x2     0.032     0.000     0.000     0.011     0.000
d_y3_d_x2     0.000     0.034     0.000     0.000     0.002
d_y1_d_x3     0.000     0.000    -0.001     0.000     0.000
d_y2_d_x3     0.021     0.000     0.000     0.010     0.000
d_y3_d_x3     0.000     0.023     0.000     0.000     0.012
d_y1_d_x4     0.000     0.000     0.039     0.000     0.000
d_y2_d_x4     0.010     0.000     0.000     0.166     0.000
d_y3_d_x4     0.000     0.012     0.000     0.000     0.135
> all.equal( summary( margEffUnc )[ , ], 
+    summary( margEffUncM )[ 1:( 12 * nObs ), ], check.attributes = FALSE )
[1] TRUE
> printCoefmat( summary( margEffUncM )[ -( 1:( 12 * (nObs-1) ) ), ], digits = 3 )
                Estimate Std. error z value Pr(> z)  
10: d_y1_d_x1    0.00210    0.01085    0.19   0.847  
10: d_y2_d_x1    0.24266    0.50885    0.48   0.633  
10: d_y3_d_x1   -0.12794    0.36564   -0.35   0.726  
10: d_y1_d_x2   -0.02934    0.12716   -0.23   0.818  
10: d_y2_d_x2    0.11782    0.34949    0.34   0.736  
10: d_y3_d_x2   -0.15753    0.40735   -0.39   0.699  
10: d_y1_d_x3    0.00936    0.03928    0.24   0.812  
10: d_y2_d_x3   -0.15640    0.29876   -0.52   0.601  
10: d_y3_d_x3    0.15952    0.28002    0.57   0.569  
10: d_y1_d_x4   -0.00535    0.02454   -0.22   0.827  
10: d_y2_d_x4   -0.20853    0.55887   -0.37   0.709  
10: d_y3_d_x4    0.17402    0.46353    0.38   0.707  
mean: d_y1_d_x1  0.21018    0.24829    0.85   0.397  
mean: d_y2_d_x1  0.24298    0.26401    0.92   0.357  
mean: d_y3_d_x1 -0.14850    0.25618   -0.58   0.562  
mean: d_y1_d_x2 -0.23573    0.24784   -0.95   0.342  
mean: d_y2_d_x2  0.17107    0.28563    0.60   0.549  
mean: d_y3_d_x2 -0.20352    0.29221   -0.70   0.486  
mean: d_y1_d_x3  0.25367    0.14107    1.80   0.072 .
mean: d_y2_d_x3 -0.30326    0.14494   -2.09   0.036 *
mean: d_y3_d_x3  0.27510    0.15051    1.83   0.068 .
mean: d_y1_d_x4 -0.14496    0.19675   -0.74   0.461  
mean: d_y2_d_x4 -0.40435    0.40735   -0.99   0.321  
mean: d_y3_d_x4  0.30010    0.36794    0.82   0.415  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> 
> # for testing state of random number generator
> rnorm( 4 )
[1] -0.5075 -0.4008  0.9871 -1.2228
> 
> # calculating marginal effects, conditional
> # (assuming that all other dependent variables are one)
> margEffCond <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE,
+    algorithm = GenzBretz() )
> round( margEffCond, 3 )
   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.412     0.118    -0.360    -0.229     0.246    -0.126     0.177
2      0.307     0.165    -0.221    -0.251     0.236    -0.173     0.471
3      0.267     0.227    -0.383    -0.358     0.230    -0.148     0.441
4      0.374     0.276    -0.356    -0.347     0.264    -0.156     0.520
5      0.439     0.271    -0.262    -0.321     0.263    -0.163     0.330
6      0.133     0.051    -0.384    -0.272     0.060    -0.110     0.254
7      0.119     0.145    -0.160    -0.009     0.113    -0.155     0.036
8      0.048     0.350    -0.234    -0.203     0.240    -0.177     0.147
9      0.549     0.018    -0.116    -0.323     0.074    -0.103     0.361
10     0.000     0.232    -0.130    -0.006     0.111    -0.166     0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.352     0.223    -0.147    -0.329     0.604
2     -0.391     0.242    -0.401    -0.405     0.497
3     -0.337     0.235    -0.380    -0.325     0.572
4     -0.451     0.244    -0.414    -0.449     0.567
5     -0.505     0.279    -0.224    -0.568     0.488
6     -0.052     0.158    -0.278    -0.048     0.386
7     -0.310     0.298    -0.022    -0.399     0.357
8     -0.386     0.284    -0.091    -0.467     0.407
9     -0.071     0.142    -0.393    -0.066     0.334
10    -0.149     0.185    -0.001    -0.199     0.199
> margEffCondA <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = allCoef,
+    data = as.data.frame( xMat ), cond = TRUE,
+    algorithm = GenzBretz() )
> all.equal( margEffCond, margEffCondA )
[1] TRUE
> # now with dummy variables specified explicitly
> margEffCondD <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE,
+    dummyVars = c( "x1", "x2" ), algorithm = GenzBretz() )
> all.equal( margEffCondD, margEffCond )
[1] TRUE
> # now with seemingly no dummy variables
> margEffCondD0 <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE,
+    dummyVars = NULL, algorithm = GenzBretz() )
> round( margEffCondD0, 3 )
   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.188     0.171    -0.423    -0.126     0.188    -0.129     0.177
2      0.510     0.225    -0.326    -0.335     0.204    -0.147     0.471
3      0.482     0.173    -0.392    -0.315     0.179    -0.138     0.441
4      0.539     0.243    -0.384    -0.369     0.238    -0.146     0.520
5      0.308     0.329    -0.304    -0.231     0.261    -0.175     0.330
6      0.329     0.025    -0.266    -0.186     0.028    -0.091     0.254
7      0.031     0.247    -0.187    -0.025     0.155    -0.192     0.036
8      0.130     0.281    -0.234    -0.103     0.196    -0.181     0.147
9      0.466     0.035    -0.229    -0.265     0.038    -0.082     0.361
10     0.001     0.125    -0.097    -0.001     0.074    -0.120     0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.352     0.223    -0.147    -0.329     0.604
2     -0.391     0.242    -0.401    -0.405     0.497
3     -0.337     0.235    -0.380    -0.325     0.572
4     -0.451     0.244    -0.414    -0.449     0.567
5     -0.505     0.279    -0.224    -0.568     0.488
6     -0.052     0.158    -0.278    -0.048     0.386
7     -0.310     0.298    -0.022    -0.399     0.357
8     -0.386     0.284    -0.091    -0.467     0.407
9     -0.071     0.142    -0.393    -0.066     0.334
10    -0.149     0.185    -0.001    -0.199     0.199
> # now with seemingly only dummy variables
> margEffCondDA <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE,
+    dummyVars = c( "x1", "x2", "x3", "x4" ), algorithm = GenzBretz() )
> round( margEffCondDA, 3 )
   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.412     0.118    -0.360    -0.229     0.246    -0.126     0.432
2      0.307     0.165    -0.221    -0.251     0.236    -0.173     0.224
3      0.267     0.227    -0.383    -0.358     0.230    -0.148     0.188
4      0.374     0.276    -0.356    -0.347     0.264    -0.156     0.184
5      0.439     0.271    -0.262    -0.321     0.263    -0.163     0.027
6      0.133     0.051    -0.384    -0.272     0.060    -0.110     0.142
7      0.119     0.145    -0.160    -0.009     0.113    -0.155     0.115
8      0.048     0.350    -0.234    -0.203     0.240    -0.177     0.074
9      0.549     0.018    -0.116    -0.323     0.074    -0.103     0.221
10     0.000     0.232    -0.130    -0.006     0.111    -0.166     0.041
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.269     0.163    -0.142    -0.358     0.544
2     -0.462     0.308    -0.328    -0.490     0.435
3     -0.298     0.232    -0.447    -0.183     0.404
4     -0.304     0.237    -0.412    -0.294     0.443
5     -0.161     0.172    -0.165    -0.508     0.472
6     -0.369     0.284    -0.354    -0.037     0.290
7     -0.406     0.312    -0.021    -0.416     0.360
8     -0.264     0.241    -0.146    -0.205     0.233
9     -0.462     0.309    -0.127    -0.330     0.549
10    -0.374     0.320    -0.004    -0.017     0.047
> # now with integrals obtained by the Miwa algorithm, reduced precision
> margEffCond1 <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE,
+    algorithm = Miwa( steps = 32 ) )
> round( margEffCond1, 3 )
   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.412     0.117    -0.360    -0.229     0.246    -0.126     0.177
2      0.307     0.165    -0.221    -0.251     0.236    -0.173     0.471
3      0.267     0.228    -0.384    -0.358     0.230    -0.148     0.441
4      0.374     0.276    -0.356    -0.347     0.264    -0.156     0.520
5      0.439     0.271    -0.262    -0.320     0.263    -0.163     0.330
6      0.133     0.051    -0.384    -0.271     0.060    -0.110     0.254
7      0.119     0.145    -0.160    -0.009     0.113    -0.155     0.036
8      0.048     0.350    -0.234    -0.203     0.240    -0.177     0.147
9      0.549     0.018    -0.116    -0.323     0.074    -0.103     0.361
10     0.000     0.232    -0.130    -0.006     0.111    -0.166     0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.352     0.223    -0.147    -0.329     0.604
2     -0.391     0.242    -0.401    -0.405     0.497
3     -0.337     0.235    -0.380    -0.325     0.572
4     -0.451     0.244    -0.414    -0.449     0.568
5     -0.505     0.279    -0.224    -0.568     0.488
6     -0.052     0.158    -0.278    -0.048     0.386
7     -0.310     0.298    -0.022    -0.399     0.357
8     -0.386     0.284    -0.091    -0.467     0.407
9     -0.071     0.142    -0.393    -0.066     0.334
10    -0.149     0.185    -0.001    -0.199     0.199
> all.equal( margEffCond, margEffCond1, tol = 1e-3 )
[1] TRUE
> # now with integrals obtained by the GHK algorithm
> margEffCond2 <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE )
> round( margEffCond2, 3 )
   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.411     0.117    -0.360    -0.229     0.246    -0.126     0.176
2      0.306     0.165    -0.221    -0.251     0.236    -0.173     0.470
3      0.267     0.228    -0.384    -0.358     0.231    -0.148     0.440
4      0.374     0.276    -0.356    -0.347     0.264    -0.156     0.520
5      0.439     0.271    -0.262    -0.320     0.263    -0.163     0.330
6      0.133     0.051    -0.384    -0.271     0.060    -0.110     0.253
7      0.119     0.145    -0.160    -0.009     0.113    -0.155     0.036
8      0.048     0.350    -0.234    -0.203     0.240    -0.177     0.147
9      0.545     0.017    -0.116    -0.323     0.074    -0.103     0.361
10     0.001     0.232    -0.130    -0.006     0.111    -0.166     0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.352     0.223    -0.147    -0.329     0.604
2     -0.391     0.242    -0.400    -0.405     0.497
3     -0.337     0.235    -0.380    -0.325     0.572
4     -0.452     0.244    -0.414    -0.449     0.568
5     -0.505     0.279    -0.223    -0.568     0.488
6     -0.052     0.158    -0.278    -0.048     0.386
7     -0.310     0.298    -0.022    -0.399     0.358
8     -0.386     0.284    -0.091    -0.467     0.407
9     -0.071     0.141    -0.392    -0.066     0.334
10    -0.149     0.185    -0.001    -0.199     0.200
> all.equal( margEffCond, margEffCond2, tol = 1e-3 )
[1] "Component \"d_y1_d_x1\": Mean relative difference: 0.002442"
[2] "Component \"d_y1_d_x3\": Mean relative difference: 0.00105" 
[3] "Component \"d_y1_d_x4\": Mean relative difference: 0.002044"
> all.equal( margEffCond1, margEffCond2, tol = 1e-3 )
[1] "Component \"d_y1_d_x1\": Mean relative difference: 0.002494"
[2] "Component \"d_y1_d_x3\": Mean relative difference: 0.001127"
[3] "Component \"d_y1_d_x4\": Mean relative difference: 0.002149"
> # now with integrals obtained by the GHK algorithm, reduced precision
> margEffCond3 <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat ), cond = TRUE,
+    nGHK = 100 )
> round( margEffCond3, 3 )
   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.415     0.120    -0.360    -0.230     0.246    -0.126     0.177
2      0.319     0.172    -0.220    -0.252     0.236    -0.173     0.471
3      0.267     0.227    -0.383    -0.359     0.230    -0.148     0.441
4      0.375     0.276    -0.355    -0.348     0.264    -0.156     0.521
5      0.441     0.271    -0.261    -0.321     0.263    -0.163     0.331
6      0.134     0.053    -0.384    -0.272     0.061    -0.110     0.254
7      0.120     0.145    -0.160    -0.009     0.113    -0.154     0.037
8      0.049     0.350    -0.234    -0.204     0.240    -0.177     0.149
9      0.573     0.043    -0.116    -0.324     0.076    -0.104     0.362
10     0.000     0.232    -0.130    -0.006     0.111    -0.166     0.002
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.351     0.223    -0.147    -0.328     0.603
2     -0.392     0.242    -0.407    -0.408     0.496
3     -0.337     0.235    -0.382    -0.326     0.571
4     -0.451     0.244    -0.417    -0.449     0.567
5     -0.505     0.279    -0.226    -0.567     0.488
6     -0.056     0.158    -0.282    -0.059     0.385
7     -0.310     0.297    -0.022    -0.400     0.357
8     -0.386     0.284    -0.092    -0.467     0.407
9     -0.076     0.142    -0.400    -0.080     0.334
10    -0.149     0.185    -0.001    -0.200     0.199
> all.equal( margEffCond, margEffCond3, tol = 1e-3 )
 [1] "Component \"d_y1_d_x1\": Mean relative difference: 0.01725" 
 [2] "Component \"d_y2_d_x1\": Mean relative difference: 0.02084" 
 [3] "Component \"d_y3_d_x1\": Mean relative difference: 0.001415"
 [4] "Component \"d_y1_d_x2\": Mean relative difference: 0.002659"
 [5] "Component \"d_y2_d_x2\": Mean relative difference: 0.0026"  
 [6] "Component \"d_y1_d_x3\": Mean relative difference: 0.003312"
 [7] "Component \"d_y2_d_x3\": Mean relative difference: 0.003941"
 [8] "Component \"d_y1_d_x4\": Mean relative difference: 0.01059" 
 [9] "Component \"d_y2_d_x4\": Mean relative difference: 0.009373"
[10] "Component \"d_y3_d_x4\": Mean relative difference: 0.001292"
> all.equal( margEffCond2, margEffCond3, tol = 1e-3 )
 [1] "Component \"d_y1_d_x1\": Mean relative difference: 0.01974" 
 [2] "Component \"d_y2_d_x1\": Mean relative difference: 0.02169" 
 [3] "Component \"d_y3_d_x1\": Mean relative difference: 0.001724"
 [4] "Component \"d_y1_d_x2\": Mean relative difference: 0.003645"
 [5] "Component \"d_y2_d_x2\": Mean relative difference: 0.003015"
 [6] "Component \"d_y3_d_x2\": Mean relative difference: 0.00122" 
 [7] "Component \"d_y1_d_x3\": Mean relative difference: 0.004366"
 [8] "Component \"d_y2_d_x3\": Mean relative difference: 0.004112"
 [9] "Component \"d_y3_d_x3\": Mean relative difference: 0.001129"
[10] "Component \"d_y1_d_x4\": Mean relative difference: 0.01247" 
[11] "Component \"d_y2_d_x4\": Mean relative difference: 0.009524"
[12] "Component \"d_y3_d_x4\": Mean relative difference: 0.001516"
> # now with variance covariance matrix and Jacobian
> margEffCondV <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat )[ c(1,5,10), ], cond = TRUE, 
+    vcov = diag( 18 ), returnJacobian = TRUE, algorithm = GenzBretz() )
> round( attr( margEffCondV, "vcov" ), 3 )
, , d_y1_d_x1

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.975    -0.003    -0.449    -0.227     0.007     0.159     0.393
5      0.291     0.039    -0.058     0.027    -0.076     0.007     0.055
10     0.000     0.000     0.000     0.000     0.000     0.000     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.055    -0.243    -0.494     -0.02     0.270
5      0.092    -0.021    -0.260     -0.04     0.082
10     0.000     0.000     0.000      0.00     0.000

, , d_y2_d_x1

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.003     0.321     0.081     0.089    -0.005    -0.052    -0.044
5      0.039     0.256     0.052    -0.032    -0.050    -0.037     0.112
10     0.000     0.263     0.020    -0.003     0.089     0.026     0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.366     0.038    -0.019    -0.654    -0.055
5     -0.091     0.035    -0.145    -0.085     0.054
10    -0.109    -0.038     0.000    -0.202    -0.044

, , d_y3_d_x1

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.449     0.081     0.765     0.066    -0.008    -0.389    -0.059
5     -0.058     0.052     0.259    -0.104     0.008    -0.017     0.208
10     0.000     0.020     0.139    -0.001     0.005     0.050     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.077     0.474     0.190    -0.147    -0.375
5     -0.050    -0.084    -0.071    -0.029    -0.060
10    -0.006    -0.048     0.000    -0.010    -0.092

, , d_y1_d_x2

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.227     0.089     0.066     0.243    -0.052    -0.111    -0.163
5      0.027    -0.032    -0.104     0.381    -0.066    -0.073    -0.366
10     0.000    -0.003    -0.001     0.003    -0.003    -0.006    -0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.066     0.035     0.145    -0.178    -0.031
5      0.065     0.005     0.164     0.006     0.024
10     0.002     0.005     0.000     0.004     0.006

, , d_y2_d_x2

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.007    -0.005    -0.008    -0.052     0.121     0.042     0.007
5     -0.076    -0.050     0.008    -0.066     0.181     0.040    -0.006
10     0.000     0.089     0.005    -0.003     0.124     0.032     0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.025    -0.007    -0.002    -0.005    -0.007
5     -0.051    -0.003     0.088     0.004    -0.003
10    -0.068    -0.030     0.000    -0.124    -0.034

, , d_y3_d_x2

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.159    -0.052    -0.389    -0.111     0.042     0.390     0.012
5      0.007    -0.037    -0.017    -0.073     0.040     0.292    -0.069
10     0.000     0.026     0.050    -0.006     0.032     0.195     0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.036    -0.259    -0.068     0.106     0.149
5      0.013    -0.143    -0.018     0.063     0.011
10    -0.020    -0.092    -0.001    -0.029    -0.140

, , d_y1_d_x3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.393    -0.044    -0.059    -0.163     0.007     0.012     0.304
5      0.055     0.112     0.208    -0.366    -0.006    -0.069     0.888
10     0.000     0.001     0.000    -0.001     0.001     0.001     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.015    -0.087    -0.267     0.088     0.050
5     -0.131    -0.085    -0.488    -0.041    -0.014
10    -0.001    -0.001     0.000    -0.001    -0.001

, , d_y2_d_x3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.055    -0.366    -0.077    -0.066     0.025     0.036    -0.015
5      0.092    -0.091    -0.050     0.065    -0.051     0.013    -0.131
10     0.000    -0.109    -0.006     0.002    -0.068    -0.020    -0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.534     0.028     0.050     0.788     0.082
5      0.368     0.027    -0.043     0.041    -0.030
10     0.090     0.030     0.000     0.157     0.034

, , d_y3_d_x3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.243     0.038     0.474     0.035    -0.007    -0.259    -0.087
5     -0.021     0.035    -0.084     0.005    -0.003    -0.143    -0.085
10     0.000    -0.038    -0.048     0.005    -0.030    -0.092    -0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.028     0.542     0.117    -0.079    -0.185
5      0.027     0.443     0.092    -0.093     0.038
10     0.030     0.134     0.001     0.039     0.169

, , d_y1_d_x4

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.494    -0.019     0.190     0.145    -0.002    -0.068    -0.267
5     -0.260    -0.145    -0.071     0.164     0.088    -0.018    -0.488
10     0.000     0.000     0.000     0.000     0.000    -0.001     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.050     0.117     0.349     0.024    -0.186
5     -0.043     0.092     0.654     0.044    -0.143
10     0.000     0.001     0.000     0.001     0.001

, , d_y2_d_x4

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      -0.02    -0.654    -0.147    -0.178    -0.005     0.106     0.088
5      -0.04    -0.085    -0.029     0.006     0.004     0.063    -0.041
10      0.00    -0.202    -0.010     0.004    -0.124    -0.029    -0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.788    -0.079     0.024     1.455     0.134
5      0.041    -0.093     0.044     0.250    -0.045
10     0.157     0.039     0.001     0.303     0.051

, , d_y3_d_x4

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.270    -0.055    -0.375    -0.031    -0.007     0.149     0.050
5      0.082     0.054    -0.060     0.024    -0.003     0.011    -0.014
10     0.000    -0.044    -0.092     0.006    -0.034    -0.140    -0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.082    -0.185    -0.186     0.134     0.442
5     -0.030     0.038    -0.143    -0.045     0.229
10     0.034     0.169     0.001     0.051     0.286

> round( drop( attr( margEffCondV, "vcov" )[ 1, , ] ), 3 )
          d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
d_y1_d_x1     0.975    -0.003    -0.449    -0.227     0.007     0.159     0.393
d_y2_d_x1    -0.003     0.321     0.081     0.089    -0.005    -0.052    -0.044
d_y3_d_x1    -0.449     0.081     0.765     0.066    -0.008    -0.389    -0.059
d_y1_d_x2    -0.227     0.089     0.066     0.243    -0.052    -0.111    -0.163
d_y2_d_x2     0.007    -0.005    -0.008    -0.052     0.121     0.042     0.007
d_y3_d_x2     0.159    -0.052    -0.389    -0.111     0.042     0.390     0.012
d_y1_d_x3     0.393    -0.044    -0.059    -0.163     0.007     0.012     0.304
d_y2_d_x3    -0.055    -0.366    -0.077    -0.066     0.025     0.036    -0.015
d_y3_d_x3    -0.243     0.038     0.474     0.035    -0.007    -0.259    -0.087
d_y1_d_x4    -0.494    -0.019     0.190     0.145    -0.002    -0.068    -0.267
d_y2_d_x4    -0.020    -0.654    -0.147    -0.178    -0.005     0.106     0.088
d_y3_d_x4     0.270    -0.055    -0.375    -0.031    -0.007     0.149     0.050
          d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
d_y1_d_x1    -0.055    -0.243    -0.494    -0.020     0.270
d_y2_d_x1    -0.366     0.038    -0.019    -0.654    -0.055
d_y3_d_x1    -0.077     0.474     0.190    -0.147    -0.375
d_y1_d_x2    -0.066     0.035     0.145    -0.178    -0.031
d_y2_d_x2     0.025    -0.007    -0.002    -0.005    -0.007
d_y3_d_x2     0.036    -0.259    -0.068     0.106     0.149
d_y1_d_x3    -0.015    -0.087    -0.267     0.088     0.050
d_y2_d_x3     0.534     0.028     0.050     0.788     0.082
d_y3_d_x3     0.028     0.542     0.117    -0.079    -0.185
d_y1_d_x4     0.050     0.117     0.349     0.024    -0.186
d_y2_d_x4     0.788    -0.079     0.024     1.455     0.134
d_y3_d_x4     0.082    -0.185    -0.186     0.134     0.442
> round( attr( margEffCondV, "jacobian" ), 3 )
, , b_1_0

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.284     0.037     0.078    -0.227     0.019    -0.023     0.279
5     -0.156     0.000    -0.013     0.176    -0.017    -0.044    -0.366
10    -0.001     0.000     0.001     0.017    -0.005    -0.013    -0.004
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.068     0.014    -0.233    -0.070    -0.004
5      0.050     0.088     0.242    -0.015    -0.015
10     0.001     0.004     0.002     0.000    -0.001

, , b_1_1

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.432    -0.019    -0.080     0.000     0.000     0.000     0.000
5      0.256    -0.043    -0.084     0.176    -0.017    -0.044    -0.366
10     0.000     0.000     0.000     0.000     0.000     0.000     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       0.00     0.000     0.000     0.000     0.000
5       0.05     0.088     0.242    -0.015    -0.015
10      0.00     0.000     0.000     0.000     0.000

, , b_1_2

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.284     0.037     0.078     0.148    -0.056    -0.158     0.279
5      0.000     0.000     0.000     0.432    -0.060    -0.127     0.000
10     0.000     0.000     0.000     0.018    -0.005    -0.014     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.068     0.014    -0.233     -0.07    -0.004
5      0.000     0.000     0.000      0.00     0.000
10     0.000     0.000     0.000      0.00     0.000

, , b_1_3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.304    -0.039    -0.083     0.243    -0.021     0.025    -0.150
5      0.098     0.000     0.008    -0.110     0.011     0.027     0.485
10    -0.001     0.000     0.001     0.022    -0.006    -0.017    -0.005
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.016    -0.173     0.249     0.074     0.005
5     -0.075    -0.139    -0.152     0.009     0.009
10     0.001     0.004     0.003     0.000    -0.001

, , b_1_4

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.121     0.016     0.033    -0.097     0.008    -0.010     0.119
5     -0.128     0.000    -0.010     0.144    -0.014    -0.036    -0.300
10     0.000     0.000     0.000    -0.007     0.002     0.005     0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.028     0.006     0.048    -0.086    -0.160
5      0.041     0.073     0.456    -0.055    -0.096
10    -0.001    -0.003     0.000     0.000    -0.001

, , b_2_0

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.009    -0.153    -0.020     0.039    -0.143    -0.012    -0.043
5      0.033     0.141     0.009    -0.015    -0.048    -0.005     0.047
10     0.000     0.220     0.007    -0.003     0.133     0.013     0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.351     0.031     0.013     0.328     0.029
5     -0.080    -0.002    -0.052    -0.082     0.010
10    -0.226    -0.018    -0.001    -0.302    -0.019

, , b_2_1

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.025     0.103     0.007     0.000     0.000     0.000     0.000
5     -0.041     0.401     0.037    -0.015    -0.048    -0.005     0.047
10     0.000     0.347     0.023     0.000     0.000     0.000     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       0.00     0.000     0.000     0.000      0.00
5      -0.08    -0.002    -0.052    -0.082      0.01
10      0.00     0.000     0.000     0.000      0.00

, , b_2_2

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.009    -0.153     -0.02    -0.016     0.256     0.026    -0.043
5      0.000     0.000      0.00    -0.056     0.353     0.033     0.000
10     0.000     0.000      0.00    -0.003     0.260     0.029     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.351     0.031     0.013     0.328     0.029
5      0.000     0.000     0.000     0.000     0.000
10     0.000     0.000     0.000     0.000     0.000

, , b_2_3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.010     0.164     0.021    -0.041     0.152     0.013     0.029
5     -0.021    -0.088    -0.006     0.009     0.030     0.003    -0.071
10     0.000     0.275     0.008    -0.004     0.166     0.016     0.002
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.117    -0.007    -0.014    -0.350    -0.032
5      0.450     0.038     0.032     0.051    -0.007
10    -0.157    -0.007     0.000    -0.379    -0.023

, , b_2_4

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.004    -0.065    -0.008     0.017    -0.061    -0.005    -0.018
5      0.027     0.116     0.007    -0.012    -0.039    -0.004     0.039
10     0.000    -0.084    -0.003     0.001    -0.051    -0.005     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.150     0.013    -0.011     0.396     0.039
5     -0.066    -0.002    -0.084     0.333     0.045
10     0.086     0.008     0.000     0.242     0.023

, , b_3_0

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.104    -0.016    -0.169     0.059    -0.008     0.032    -0.080
5      0.009     0.019     0.183    -0.062     0.007     0.024     0.117
10     0.000     0.011     0.124    -0.005     0.010     0.151     0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.033    -0.015     0.083     0.021    -0.034
5     -0.027    -0.101    -0.039    -0.020    -0.141
10    -0.010    -0.231     0.000    -0.012    -0.247

, , b_3_1

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.149     0.014     0.263     0.000     0.000     0.000     0.000
5     -0.071     0.033     0.401    -0.062     0.007     0.024     0.117
10     0.000     0.015     0.311     0.000     0.000     0.000     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.000     0.000     0.000      0.00     0.000
5     -0.027    -0.101    -0.039     -0.02    -0.141
10     0.000     0.000     0.000      0.00     0.000

, , b_3_2

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.104    -0.016    -0.169    -0.045     0.030     0.433     -0.08
5      0.000     0.000     0.000    -0.133     0.040     0.424      0.00
10     0.000     0.000     0.000    -0.005     0.013     0.338      0.00
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.032    -0.015     0.083     0.021    -0.033
5      0.000     0.000     0.000     0.000     0.000
10     0.000     0.000     0.000     0.000     0.000

, , b_3_3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.111     0.017     0.181    -0.062     0.009    -0.034     0.040
5     -0.006    -0.012    -0.115     0.039    -0.004    -0.015    -0.143
10     0.000     0.014     0.155    -0.006     0.012     0.189     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.006     0.448    -0.089    -0.023     0.036
5      0.050     0.464     0.025     0.013     0.088
10    -0.009    -0.103    -0.001    -0.015    -0.310

, , b_3_4

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.044    -0.007    -0.072     0.025    -0.004     0.014    -0.034
5      0.008     0.016     0.151    -0.051     0.006     0.019     0.095
10     0.000    -0.004    -0.047     0.002    -0.004    -0.057     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.014    -0.006    -0.010     0.039     0.418
5     -0.023    -0.084    -0.105     0.016     0.284
10     0.004     0.088     0.001     0.008     0.282

, , R_1_2

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.012    -0.473    -0.023    -0.237     0.035     0.048     0.188
5     -0.389    -0.135     0.006    -0.026     0.200     0.038    -0.136
10    -0.002     0.000     0.002     0.034     0.006    -0.021    -0.011
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.457    -0.036    -0.002     0.963     0.019
5     -0.302    -0.033     0.513     0.115    -0.070
10    -0.001     0.009     0.007     0.000    -0.003

, , R_1_3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.678    -0.044    -0.752    -0.153     0.013     0.394     0.216
5      0.110    -0.027    -0.134     0.254     0.002     0.254    -0.444
10    -0.001     0.000    -0.001     0.021    -0.003     0.015    -0.004
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.011    -0.517    -0.389     0.089     0.452
5      0.016    -0.312    -0.034     0.042     0.175
10     0.001    -0.004     0.002     0.000     0.002

, , R_2_3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.030    -0.032    -0.084     0.090    -0.038    -0.124    -0.101
5      0.051     0.179     0.042    -0.036     0.052    -0.143     0.110
10     0.000     0.107    -0.004    -0.010     0.089     0.127     0.003
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.174     0.201     0.036     0.005     0.170
5     -0.200     0.244    -0.117    -0.321     0.232
10    -0.081    -0.249    -0.002    -0.098    -0.218

> round( drop( attr( margEffCondV, "jacobian" )[ 1, , ] ), 3 )
           b_1_0  b_1_1  b_1_2  b_1_3  b_1_4  b_2_0  b_2_1  b_2_2  b_2_3  b_2_4
d_y1_d_x1  0.284  0.432  0.284 -0.304  0.121 -0.009 -0.025 -0.009  0.010 -0.004
d_y2_d_x1  0.037 -0.019  0.037 -0.039  0.016 -0.153  0.103 -0.153  0.164 -0.065
d_y3_d_x1  0.078 -0.080  0.078 -0.083  0.033 -0.020  0.007 -0.020  0.021 -0.008
d_y1_d_x2 -0.227  0.000  0.148  0.243 -0.097  0.039  0.000 -0.016 -0.041  0.017
d_y2_d_x2  0.019  0.000 -0.056 -0.021  0.008 -0.143  0.000  0.256  0.152 -0.061
d_y3_d_x2 -0.023  0.000 -0.158  0.025 -0.010 -0.012  0.000  0.026  0.013 -0.005
d_y1_d_x3  0.279  0.000  0.279 -0.150  0.119 -0.043  0.000 -0.043  0.029 -0.018
d_y2_d_x3 -0.068  0.000 -0.068  0.016 -0.028  0.351  0.000  0.351 -0.117  0.150
d_y3_d_x3  0.014  0.000  0.014 -0.173  0.006  0.031  0.000  0.031 -0.007  0.013
d_y1_d_x4 -0.233  0.000 -0.233  0.249  0.048  0.013  0.000  0.013 -0.014 -0.011
d_y2_d_x4 -0.070  0.000 -0.070  0.074 -0.086  0.328  0.000  0.328 -0.350  0.396
d_y3_d_x4 -0.004  0.000 -0.004  0.005 -0.160  0.029  0.000  0.029 -0.032  0.039
           b_3_0  b_3_1  b_3_2  b_3_3  b_3_4  R_1_2  R_1_3  R_2_3
d_y1_d_x1 -0.104 -0.149 -0.104  0.111 -0.044  0.012  0.678 -0.030
d_y2_d_x1 -0.016  0.014 -0.016  0.017 -0.007 -0.473 -0.044 -0.032
d_y3_d_x1 -0.169  0.263 -0.169  0.181 -0.072 -0.023 -0.752 -0.084
d_y1_d_x2  0.059  0.000 -0.045 -0.062  0.025 -0.237 -0.153  0.090
d_y2_d_x2 -0.008  0.000  0.030  0.009 -0.004  0.035  0.013 -0.038
d_y3_d_x2  0.032  0.000  0.433 -0.034  0.014  0.048  0.394 -0.124
d_y1_d_x3 -0.080  0.000 -0.080  0.040 -0.034  0.188  0.216 -0.101
d_y2_d_x3  0.033  0.000  0.032 -0.006  0.014  0.457  0.011  0.174
d_y3_d_x3 -0.015  0.000 -0.015  0.448 -0.006 -0.036 -0.517  0.201
d_y1_d_x4  0.083  0.000  0.083 -0.089 -0.010 -0.002 -0.389  0.036
d_y2_d_x4  0.021  0.000  0.021 -0.023  0.039  0.963  0.089  0.005
d_y3_d_x4 -0.034  0.000 -0.033  0.036  0.418  0.019  0.452  0.170
> print( summary( margEffCondV ), digits = 3 )
              Estimate Std. error z value Pr(> z)
1: d_y1_d_x1  0.411820   0.987470    0.42    0.68
1: d_y2_d_x1  0.117554   0.566841    0.21    0.84
1: d_y3_d_x1 -0.360357   0.874767   -0.41    0.68
1: d_y1_d_x2 -0.229336   0.493308   -0.46    0.64
1: d_y2_d_x2  0.245929   0.347387    0.71    0.48
1: d_y3_d_x2 -0.125805   0.624447   -0.20    0.84
1: d_y1_d_x3  0.176512   0.551496    0.32    0.75
1: d_y2_d_x3 -0.351793   0.730841   -0.48    0.63
1: d_y3_d_x3  0.222984   0.736245    0.30    0.76
1: d_y1_d_x4 -0.146837   0.590426   -0.25    0.80
1: d_y2_d_x4 -0.328722   1.206289   -0.27    0.79
1: d_y3_d_x4  0.603735   0.664542    0.91    0.36
2: d_y1_d_x1  0.439180   0.539681    0.81    0.42
2: d_y2_d_x1  0.270827   0.506415    0.53    0.59
2: d_y3_d_x1 -0.261575   0.508675   -0.51    0.61
2: d_y1_d_x2 -0.320545   0.616944   -0.52    0.60
2: d_y2_d_x2  0.263154   0.425100    0.62    0.54
2: d_y3_d_x2 -0.163006   0.539915   -0.30    0.76
2: d_y1_d_x3  0.329853   0.942591    0.35    0.73
2: d_y2_d_x3 -0.505313   0.606561   -0.83    0.40
2: d_y3_d_x3  0.279124   0.665465    0.42    0.67
2: d_y1_d_x4 -0.223869   0.808860   -0.28    0.78
2: d_y2_d_x4 -0.567550   0.499684   -1.14    0.26
2: d_y3_d_x4  0.488327   0.479037    1.02    0.31
3: d_y1_d_x1  0.000202   0.002780    0.07    0.94
3: d_y2_d_x1  0.231970   0.513273    0.45    0.65
3: d_y3_d_x1 -0.130110   0.372877   -0.35    0.73
3: d_y1_d_x2 -0.005713   0.054480   -0.10    0.92
3: d_y2_d_x2  0.110991   0.351961    0.32    0.75
3: d_y3_d_x2 -0.166167   0.441134   -0.38    0.71
3: d_y1_d_x3  0.001136   0.014178    0.08    0.94
3: d_y2_d_x3 -0.149187   0.299851   -0.50    0.62
3: d_y3_d_x3  0.185344   0.366606    0.51    0.61
3: d_y1_d_x4 -0.000621   0.008580   -0.07    0.94
3: d_y2_d_x4 -0.199202   0.550816   -0.36    0.72
3: d_y3_d_x4  0.199446   0.534888    0.37    0.71
> margEffCondVA <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = allCoef,
+    data = as.data.frame( xMat )[ c(1,5,10), ], cond = TRUE, 
+    vcov = diag( 18 ), returnJacobian = TRUE, algorithm = GenzBretz() )
> all.equal( margEffCondV, margEffCondVA, tol = 1e-3 )
[1] TRUE
> # now with Jacobian but without variance covariance matrix
> margEffCondJac <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = allCoef,
+    data = as.data.frame( xMat )[ c(1,5,10), ], cond = TRUE, 
+    returnJacobian = TRUE, algorithm = GenzBretz() )
> all.equal( attr( margEffCondJac, "jacobian" ), attr( margEffCondV, "jacobian" ) )
[1] TRUE
> # now with mean values of marginal effects
> margEffCondM <- mvProbitMargEff( ~ x1 + x2 + x3 + x4, coef = c( beta ), 
+    sigma = sigma, data = as.data.frame( xMat )[ c(1,5,10), ], cond = TRUE, 
+    vcov = diag( 18 ), addMean = TRUE, returnJacobian = TRUE,
+    algorithm = GenzBretz() )
> all.equal( margEffCondV, margEffCondM[ 1:3, ], check.attributes = FALSE )
[1] TRUE
> round( margEffCondM, 3 )
     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.412     0.118    -0.360    -0.229     0.246    -0.126     0.177
2        0.439     0.271    -0.262    -0.321     0.263    -0.163     0.330
3        0.000     0.232    -0.130    -0.006     0.111    -0.166     0.001
mean     0.284     0.207    -0.251    -0.185     0.207    -0.152     0.169
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.352     0.223    -0.147    -0.329     0.604
2       -0.505     0.279    -0.224    -0.568     0.488
3       -0.149     0.185    -0.001    -0.199     0.199
mean    -0.335     0.229    -0.124    -0.365     0.431
> all.equal( attr( margEffCondV, "vcov" ), 
+    attr( margEffCondM, "vcov" )[ 1:3, , ] )
[1] TRUE
> round( attr( margEffCondM, "vcov" ), 3 )
, , d_y1_d_x1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.975    -0.003    -0.449    -0.227     0.007     0.159     0.393
5        0.291     0.039    -0.058     0.027    -0.076     0.007     0.055
10       0.000     0.000     0.000     0.000     0.000     0.000     0.000
mean     0.163     0.010    -0.106     0.052    -0.016     0.025    -0.054
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.055    -0.243    -0.494    -0.020     0.270
5        0.092    -0.021    -0.260    -0.040     0.082
10       0.000     0.000     0.000     0.000     0.000
mean     0.000    -0.038    -0.051    -0.038     0.058

, , d_y2_d_x1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.003     0.321     0.081     0.089    -0.005    -0.052    -0.044
5        0.039     0.256     0.052    -0.032    -0.050    -0.037     0.112
10       0.000     0.263     0.020    -0.003     0.089     0.026     0.001
mean     0.010     0.152     0.024     0.015    -0.020    -0.017     0.005
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.366     0.038    -0.019    -0.654    -0.055
5       -0.091     0.035    -0.145    -0.085     0.054
10      -0.109    -0.038     0.000    -0.202    -0.044
mean    -0.021     0.018    -0.042    -0.131     0.000

, , d_y3_d_x1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.449     0.081     0.765     0.066    -0.008    -0.389    -0.059
5       -0.058     0.052     0.259    -0.104     0.008    -0.017     0.208
10       0.000     0.020     0.139    -0.001     0.005     0.050     0.000
mean    -0.106     0.024     0.210    -0.016    -0.004    -0.081     0.041
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.077     0.474     0.190    -0.147    -0.375
5       -0.050    -0.084    -0.071    -0.029    -0.060
10      -0.006    -0.048     0.000    -0.010    -0.092
mean    -0.007     0.087     0.028    -0.021    -0.086

, , d_y1_d_x2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.227     0.089     0.066     0.243    -0.052    -0.111    -0.163
5        0.027    -0.032    -0.104     0.381    -0.066    -0.073    -0.366
10       0.000    -0.003    -0.001     0.003    -0.003    -0.006    -0.001
mean     0.052     0.015    -0.016     0.059    -0.025    -0.039     0.014
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.066     0.035     0.145    -0.178    -0.031
5        0.065     0.005     0.164     0.006     0.024
10       0.002     0.005     0.000     0.004     0.006
mean    -0.012    -0.013    -0.027    -0.031     0.009

, , d_y2_d_x2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.007    -0.005    -0.008    -0.052     0.121     0.042     0.007
5       -0.076    -0.050     0.008    -0.066     0.181     0.040    -0.006
10       0.000     0.089     0.005    -0.003     0.124     0.032     0.001
mean    -0.016    -0.020    -0.004    -0.025     0.111     0.027    -0.010
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.025    -0.007    -0.002    -0.005    -0.007
5       -0.051    -0.003     0.088     0.004    -0.003
10      -0.068    -0.030     0.000    -0.124    -0.034
mean     0.042     0.004     0.019     0.015    -0.001

, , d_y3_d_x2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.159    -0.052    -0.389    -0.111     0.042     0.390     0.012
5        0.007    -0.037    -0.017    -0.073     0.040     0.292    -0.069
10       0.000     0.026     0.050    -0.006     0.032     0.195     0.001
mean     0.025    -0.017    -0.081    -0.039     0.027     0.229    -0.033
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.036    -0.259    -0.068     0.106     0.149
5        0.013    -0.143    -0.018     0.063     0.011
10      -0.020    -0.092    -0.001    -0.029    -0.140
mean     0.015    -0.065    -0.010     0.029     0.025

, , d_y1_d_x3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.393    -0.044    -0.059    -0.163     0.007     0.012     0.304
5        0.055     0.112     0.208    -0.366    -0.006    -0.069     0.888
10       0.000     0.001     0.000    -0.001     0.001     0.001     0.000
mean    -0.054     0.005     0.041     0.014    -0.010    -0.033     0.051
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.015    -0.087    -0.267     0.088     0.050
5       -0.131    -0.085    -0.488    -0.041    -0.014
10      -0.001    -0.001     0.000    -0.001    -0.001
mean    -0.010    -0.008    -0.012     0.009    -0.004

, , d_y2_d_x3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.055    -0.366    -0.077    -0.066     0.025     0.036    -0.015
5        0.092    -0.091    -0.050     0.065    -0.051     0.013    -0.131
10       0.000    -0.109    -0.006     0.002    -0.068    -0.020    -0.001
mean     0.000    -0.021    -0.007    -0.012     0.042     0.015    -0.010
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.534     0.028     0.050     0.788     0.082
5        0.368     0.027    -0.043     0.041    -0.030
10       0.090     0.030     0.000     0.157     0.034
mean     0.027     0.002     0.011     0.042     0.000

, , d_y3_d_x3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.243     0.038     0.474     0.035    -0.007    -0.259    -0.087
5       -0.021     0.035    -0.084     0.005    -0.003    -0.143    -0.085
10       0.000    -0.038    -0.048     0.005    -0.030    -0.092    -0.001
mean    -0.038     0.018     0.087    -0.013     0.004    -0.065    -0.008
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.028     0.542     0.117    -0.079    -0.185
5        0.027     0.443     0.092    -0.093     0.038
10       0.030     0.134     0.001     0.039     0.169
mean     0.002     0.182     0.029    -0.034    -0.056

, , d_y1_d_x4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.494    -0.019     0.190     0.145    -0.002    -0.068    -0.267
5       -0.260    -0.145    -0.071     0.164     0.088    -0.018    -0.488
10       0.000     0.000     0.000     0.000     0.000    -0.001     0.000
mean    -0.051    -0.042     0.028    -0.027     0.019    -0.010    -0.012
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.050     0.117     0.349     0.024    -0.186
5       -0.043     0.092     0.654     0.044    -0.143
10       0.000     0.001     0.000     0.001     0.001
mean     0.011     0.029     0.097     0.043    -0.063

, , d_y2_d_x4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.020    -0.654    -0.147    -0.178    -0.005     0.106     0.088
5       -0.040    -0.085    -0.029     0.006     0.004     0.063    -0.041
10       0.000    -0.202    -0.010     0.004    -0.124    -0.029    -0.001
mean    -0.038    -0.131    -0.021    -0.031     0.015     0.029     0.009
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.788    -0.079     0.024     1.455     0.134
5        0.041    -0.093     0.044     0.250    -0.045
10       0.157     0.039     0.001     0.303     0.051
mean     0.042    -0.034     0.043     0.324     0.024

, , d_y3_d_x4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.270    -0.055    -0.375    -0.031    -0.007     0.149     0.050
5        0.082     0.054    -0.060     0.024    -0.003     0.011    -0.014
10       0.000    -0.044    -0.092     0.006    -0.034    -0.140    -0.001
mean     0.058     0.000    -0.086     0.009    -0.001     0.025    -0.004
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.082    -0.185    -0.186     0.134     0.442
5       -0.030     0.038    -0.143    -0.045     0.229
10       0.034     0.169     0.001     0.051     0.286
mean     0.000    -0.056    -0.063     0.024     0.191

> round( drop( attr( margEffCondM, "vcov" )[ 4, , ] ), 3 )
          d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
d_y1_d_x1     0.163     0.010    -0.106     0.052    -0.016     0.025    -0.054
d_y2_d_x1     0.010     0.152     0.024     0.015    -0.020    -0.017     0.005
d_y3_d_x1    -0.106     0.024     0.210    -0.016    -0.004    -0.081     0.041
d_y1_d_x2     0.052     0.015    -0.016     0.059    -0.025    -0.039     0.014
d_y2_d_x2    -0.016    -0.020    -0.004    -0.025     0.111     0.027    -0.010
d_y3_d_x2     0.025    -0.017    -0.081    -0.039     0.027     0.229    -0.033
d_y1_d_x3    -0.054     0.005     0.041     0.014    -0.010    -0.033     0.051
d_y2_d_x3     0.000    -0.021    -0.007    -0.012     0.042     0.015    -0.010
d_y3_d_x3    -0.038     0.018     0.087    -0.013     0.004    -0.065    -0.008
d_y1_d_x4    -0.051    -0.042     0.028    -0.027     0.019    -0.010    -0.012
d_y2_d_x4    -0.038    -0.131    -0.021    -0.031     0.015     0.029     0.009
d_y3_d_x4     0.058     0.000    -0.086     0.009    -0.001     0.025    -0.004
          d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
d_y1_d_x1     0.000    -0.038    -0.051    -0.038     0.058
d_y2_d_x1    -0.021     0.018    -0.042    -0.131     0.000
d_y3_d_x1    -0.007     0.087     0.028    -0.021    -0.086
d_y1_d_x2    -0.012    -0.013    -0.027    -0.031     0.009
d_y2_d_x2     0.042     0.004     0.019     0.015    -0.001
d_y3_d_x2     0.015    -0.065    -0.010     0.029     0.025
d_y1_d_x3    -0.010    -0.008    -0.012     0.009    -0.004
d_y2_d_x3     0.027     0.002     0.011     0.042     0.000
d_y3_d_x3     0.002     0.182     0.029    -0.034    -0.056
d_y1_d_x4     0.011     0.029     0.097     0.043    -0.063
d_y2_d_x4     0.042    -0.034     0.043     0.324     0.024
d_y3_d_x4     0.000    -0.056    -0.063     0.024     0.191
> all.equal( attr( margEffCondV, "jacobian" ), 
+    attr( margEffCondM, "jacobian" )[ 1:3, , ] )
[1] TRUE
> round( attr( margEffCondM, "jacobian" ), 3 )
, , b_1_0

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.284     0.037     0.078    -0.227     0.019    -0.023     0.279
5       -0.156     0.000    -0.013     0.176    -0.017    -0.044    -0.366
10      -0.001     0.000     0.001     0.017    -0.005    -0.013    -0.004
mean     0.042     0.012     0.022    -0.011    -0.001    -0.027    -0.030
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.068     0.014    -0.233    -0.070    -0.004
5        0.050     0.088     0.242    -0.015    -0.015
10       0.001     0.004     0.002     0.000    -0.001
mean    -0.005     0.035     0.003    -0.028    -0.007

, , b_1_1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.432    -0.019    -0.080     0.000     0.000     0.000     0.000
5        0.256    -0.043    -0.084     0.176    -0.017    -0.044    -0.366
10       0.000     0.000     0.000     0.000     0.000     0.000     0.000
mean     0.229    -0.021    -0.055     0.059    -0.006    -0.015    -0.122
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.000     0.000     0.000     0.000     0.000
5        0.050     0.088     0.242    -0.015    -0.015
10       0.000     0.000     0.000     0.000     0.000
mean     0.017     0.029     0.081    -0.005    -0.005

, , b_1_2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.284     0.037     0.078     0.148    -0.056    -0.158     0.279
5        0.000     0.000     0.000     0.432    -0.060    -0.127     0.000
10       0.000     0.000     0.000     0.018    -0.005    -0.014     0.000
mean     0.095     0.012     0.026     0.199    -0.040    -0.100     0.093
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.068     0.014    -0.233    -0.070    -0.004
5        0.000     0.000     0.000     0.000     0.000
10       0.000     0.000     0.000     0.000     0.000
mean    -0.023     0.005    -0.078    -0.023    -0.001

, , b_1_3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.304    -0.039    -0.083     0.243    -0.021     0.025    -0.150
5        0.098     0.000     0.008    -0.110     0.011     0.027     0.485
10      -0.001     0.000     0.001     0.022    -0.006    -0.017    -0.005
mean    -0.069    -0.013    -0.025     0.052    -0.005     0.012     0.110
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.016    -0.173     0.249     0.074     0.005
5       -0.075    -0.139    -0.152     0.009     0.009
10       0.001     0.004     0.003     0.000    -0.001
mean    -0.019    -0.102     0.033     0.028     0.004

, , b_1_4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.121     0.016     0.033    -0.097     0.008    -0.010     0.119
5       -0.128     0.000    -0.010     0.144    -0.014    -0.036    -0.300
10       0.000     0.000     0.000    -0.007     0.002     0.005     0.001
mean    -0.002     0.005     0.008     0.014    -0.001    -0.014    -0.060
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.028     0.006     0.048    -0.086    -0.160
5        0.041     0.073     0.456    -0.055    -0.096
10      -0.001    -0.003     0.000     0.000    -0.001
mean     0.004     0.026     0.168    -0.047    -0.085

, , b_2_0

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.009    -0.153    -0.020     0.039    -0.143    -0.012    -0.043
5        0.033     0.141     0.009    -0.015    -0.048    -0.005     0.047
10       0.000     0.220     0.007    -0.003     0.133     0.013     0.001
mean     0.008     0.069    -0.001     0.007    -0.019    -0.001     0.002
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.351     0.031     0.013     0.328     0.029
5       -0.080    -0.002    -0.052    -0.082     0.010
10      -0.226    -0.018    -0.001    -0.302    -0.019
mean     0.015     0.003    -0.013    -0.019     0.007

, , b_2_1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.025     0.103     0.007     0.000     0.000     0.000     0.000
5       -0.041     0.401     0.037    -0.015    -0.048    -0.005     0.047
10       0.000     0.347     0.023     0.000     0.000     0.000     0.000
mean    -0.022     0.283     0.022    -0.005    -0.016    -0.002     0.016
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.000     0.000     0.000     0.000     0.000
5       -0.080    -0.002    -0.052    -0.082     0.010
10       0.000     0.000     0.000     0.000     0.000
mean    -0.027    -0.001    -0.017    -0.027     0.003

, , b_2_2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.009    -0.153    -0.020    -0.016     0.256     0.026    -0.043
5        0.000     0.000     0.000    -0.056     0.353     0.033     0.000
10       0.000     0.000     0.000    -0.003     0.260     0.029     0.000
mean    -0.003    -0.051    -0.007    -0.025     0.290     0.029    -0.014
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.351     0.031     0.013     0.328     0.029
5        0.000     0.000     0.000     0.000     0.000
10       0.000     0.000     0.000     0.000     0.000
mean     0.117     0.010     0.004     0.109     0.010

, , b_2_3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.010     0.164     0.021    -0.041     0.152     0.013     0.029
5       -0.021    -0.088    -0.006     0.009     0.030     0.003    -0.071
10       0.000     0.275     0.008    -0.004     0.166     0.016     0.002
mean    -0.004     0.117     0.008    -0.012     0.116     0.011    -0.013
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.117    -0.007    -0.014    -0.350    -0.032
5        0.450     0.038     0.032     0.051    -0.007
10      -0.157    -0.007     0.000    -0.379    -0.023
mean     0.059     0.008     0.006    -0.226    -0.020

, , b_2_4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.004    -0.065    -0.008     0.017    -0.061    -0.005    -0.018
5        0.027     0.116     0.007    -0.012    -0.039    -0.004     0.039
10       0.000    -0.084    -0.003     0.001    -0.051    -0.005     0.000
mean     0.008    -0.011    -0.001     0.002    -0.050    -0.005     0.007
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.150     0.013    -0.011     0.396     0.039
5       -0.066    -0.002    -0.084     0.333     0.045
10       0.086     0.008     0.000     0.242     0.023
mean     0.057     0.006    -0.032     0.324     0.036

, , b_3_0

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.104    -0.016    -0.169     0.059    -0.008     0.032    -0.080
5        0.009     0.019     0.183    -0.062     0.007     0.024     0.117
10       0.000     0.011     0.124    -0.005     0.010     0.151     0.001
mean    -0.031     0.005     0.046    -0.003     0.003     0.069     0.013
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.033    -0.015     0.083     0.021    -0.034
5       -0.027    -0.101    -0.039    -0.020    -0.141
10      -0.010    -0.231     0.000    -0.012    -0.247
mean    -0.001    -0.116     0.015    -0.004    -0.141

, , b_3_1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.149     0.014     0.263     0.000     0.000     0.000     0.000
5       -0.071     0.033     0.401    -0.062     0.007     0.024     0.117
10       0.000     0.015     0.311     0.000     0.000     0.000     0.000
mean    -0.073     0.021     0.325    -0.021     0.002     0.008     0.039
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.000     0.000     0.000     0.000     0.000
5       -0.027    -0.101    -0.039    -0.020    -0.141
10       0.000     0.000     0.000     0.000     0.000
mean    -0.009    -0.034    -0.013    -0.007    -0.047

, , b_3_2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.104    -0.016    -0.169    -0.045     0.030     0.433    -0.080
5        0.000     0.000     0.000    -0.133     0.040     0.424     0.000
10       0.000     0.000     0.000    -0.005     0.013     0.338     0.000
mean    -0.035    -0.005    -0.056    -0.061     0.028     0.398    -0.027
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.032    -0.015     0.083     0.021    -0.033
5        0.000     0.000     0.000     0.000     0.000
10       0.000     0.000     0.000     0.000     0.000
mean     0.011    -0.005     0.028     0.007    -0.011

, , b_3_3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.111     0.017     0.181    -0.062     0.009    -0.034     0.040
5       -0.006    -0.012    -0.115     0.039    -0.004    -0.015    -0.143
10       0.000     0.014     0.155    -0.006     0.012     0.189     0.000
mean     0.035     0.006     0.074    -0.010     0.006     0.047    -0.034
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.006     0.448    -0.089    -0.023     0.036
5        0.050     0.464     0.025     0.013     0.088
10      -0.009    -0.103    -0.001    -0.015    -0.310
mean     0.012     0.270    -0.022    -0.008    -0.062

, , b_3_4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.044    -0.007    -0.072     0.025    -0.004     0.014    -0.034
5        0.008     0.016     0.151    -0.051     0.006     0.019     0.095
10       0.000    -0.004    -0.047     0.002    -0.004    -0.057     0.000
mean    -0.012     0.002     0.010    -0.008     0.000    -0.008     0.021
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.014    -0.006    -0.010     0.039     0.418
5       -0.023    -0.084    -0.105     0.016     0.284
10       0.004     0.088     0.001     0.008     0.282
mean    -0.002     0.000    -0.038     0.021     0.328

, , R_1_2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.012    -0.473    -0.023    -0.237     0.035     0.048     0.188
5       -0.389    -0.135     0.006    -0.026     0.200     0.038    -0.136
10      -0.002     0.000     0.002     0.034     0.006    -0.021    -0.011
mean    -0.126    -0.203    -0.005    -0.076     0.081     0.022     0.013
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.457    -0.036    -0.002     0.963     0.019
5       -0.302    -0.033     0.513     0.115    -0.070
10      -0.001     0.009     0.007     0.000    -0.003
mean     0.052    -0.020     0.173     0.359    -0.018

, , R_1_3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.678    -0.044    -0.752    -0.153     0.013     0.394     0.216
5        0.110    -0.027    -0.134     0.254     0.002     0.254    -0.444
10      -0.001     0.000    -0.001     0.021    -0.003     0.015    -0.004
mean     0.262    -0.024    -0.296     0.040     0.004     0.221    -0.078
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.011    -0.517    -0.389     0.089     0.452
5        0.016    -0.312    -0.034     0.042     0.175
10       0.001    -0.004     0.002     0.000     0.002
mean     0.010    -0.278    -0.140     0.044     0.210

, , R_2_3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.030    -0.032    -0.084     0.090    -0.038    -0.124    -0.101
5        0.051     0.179     0.042    -0.036     0.052    -0.143     0.110
10       0.000     0.107    -0.004    -0.010     0.089     0.127     0.003
mean     0.007     0.084    -0.015     0.015     0.034    -0.047     0.004
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.174     0.201     0.036     0.005     0.170
5       -0.200     0.244    -0.117    -0.321     0.232
10      -0.081    -0.249    -0.002    -0.098    -0.218
mean    -0.035     0.065    -0.028    -0.138     0.061

> round( drop( attr( margEffCondM, "jacobian" )[ 4, , ] ), 3 )
           b_1_0  b_1_1  b_1_2  b_1_3  b_1_4  b_2_0  b_2_1  b_2_2  b_2_3  b_2_4
d_y1_d_x1  0.042  0.229  0.095 -0.069 -0.002  0.008 -0.022 -0.003 -0.004  0.008
d_y2_d_x1  0.012 -0.021  0.012 -0.013  0.005  0.069  0.283 -0.051  0.117 -0.011
d_y3_d_x1  0.022 -0.055  0.026 -0.025  0.008 -0.001  0.022 -0.007  0.008 -0.001
d_y1_d_x2 -0.011  0.059  0.199  0.052  0.014  0.007 -0.005 -0.025 -0.012  0.002
d_y2_d_x2 -0.001 -0.006 -0.040 -0.005 -0.001 -0.019 -0.016  0.290  0.116 -0.050
d_y3_d_x2 -0.027 -0.015 -0.100  0.012 -0.014 -0.001 -0.002  0.029  0.011 -0.005
d_y1_d_x3 -0.030 -0.122  0.093  0.110 -0.060  0.002  0.016 -0.014 -0.013  0.007
d_y2_d_x3 -0.005  0.017 -0.023 -0.019  0.004  0.015 -0.027  0.117  0.059  0.057
d_y3_d_x3  0.035  0.029  0.005 -0.102  0.026  0.003 -0.001  0.010  0.008  0.006
d_y1_d_x4  0.003  0.081 -0.078  0.033  0.168 -0.013 -0.017  0.004  0.006 -0.032
d_y2_d_x4 -0.028 -0.005 -0.023  0.028 -0.047 -0.019 -0.027  0.109 -0.226  0.324
d_y3_d_x4 -0.007 -0.005 -0.001  0.004 -0.085  0.007  0.003  0.010 -0.020  0.036
           b_3_0  b_3_1  b_3_2  b_3_3  b_3_4  R_1_2  R_1_3  R_2_3
d_y1_d_x1 -0.031 -0.073 -0.035  0.035 -0.012 -0.126  0.262  0.007
d_y2_d_x1  0.005  0.021 -0.005  0.006  0.002 -0.203 -0.024  0.084
d_y3_d_x1  0.046  0.325 -0.056  0.074  0.010 -0.005 -0.296 -0.015
d_y1_d_x2 -0.003 -0.021 -0.061 -0.010 -0.008 -0.076  0.040  0.015
d_y2_d_x2  0.003  0.002  0.028  0.006  0.000  0.081  0.004  0.034
d_y3_d_x2  0.069  0.008  0.398  0.047 -0.008  0.022  0.221 -0.047
d_y1_d_x3  0.013  0.039 -0.027 -0.034  0.021  0.013 -0.078  0.004
d_y2_d_x3 -0.001 -0.009  0.011  0.012 -0.002  0.052  0.010 -0.035
d_y3_d_x3 -0.116 -0.034 -0.005  0.270  0.000 -0.020 -0.278  0.065
d_y1_d_x4  0.015 -0.013  0.028 -0.022 -0.038  0.173 -0.140 -0.028
d_y2_d_x4 -0.004 -0.007  0.007 -0.008  0.021  0.359  0.044 -0.138
d_y3_d_x4 -0.141 -0.047 -0.011 -0.062  0.328 -0.018  0.210  0.061
> all.equal( summary( margEffCondV )[ , ], summary( margEffCondM )[ 1:36, ],
+    check.attributes = FALSE ) 
[1] TRUE
> print( summary( margEffCondM )[ -( 1:24 ), ], digits = 3 )
                 Estimate Std. error z value Pr(> z)
3: d_y1_d_x1     0.000202    0.00278  0.0728  0.9420
3: d_y2_d_x1     0.231970    0.51327  0.4519  0.6513
3: d_y3_d_x1    -0.130110    0.37288 -0.3489  0.7271
3: d_y1_d_x2    -0.005713    0.05448 -0.1049  0.9165
3: d_y2_d_x2     0.110991    0.35196  0.3153  0.7525
3: d_y3_d_x2    -0.166167    0.44113 -0.3767  0.7064
3: d_y1_d_x3     0.001136    0.01418  0.0801  0.9361
3: d_y2_d_x3    -0.149187    0.29985 -0.4975  0.6188
3: d_y3_d_x3     0.185344    0.36661  0.5056  0.6132
3: d_y1_d_x4    -0.000621    0.00858 -0.0724  0.9423
3: d_y2_d_x4    -0.199202    0.55082 -0.3616  0.7176
3: d_y3_d_x4     0.199446    0.53489  0.3729  0.7092
mean: d_y1_d_x1  0.283734    0.40330  0.7035  0.4817
mean: d_y2_d_x1  0.206784    0.38951  0.5309  0.5955
mean: d_y3_d_x1 -0.250681    0.45772 -0.5477  0.5839
mean: d_y1_d_x2 -0.185198    0.24289 -0.7625  0.4458
mean: d_y2_d_x2  0.206692    0.33272  0.6212  0.5345
mean: d_y3_d_x2 -0.151660    0.47898 -0.3166  0.7515
mean: d_y1_d_x3  0.169167    0.22594  0.7487  0.4540
mean: d_y2_d_x3 -0.335431    0.16364 -2.0498  0.0404
mean: d_y3_d_x3  0.229151    0.42713  0.5365  0.5916
mean: d_y1_d_x4 -0.123776    0.31118 -0.3978  0.6908
mean: d_y2_d_x4 -0.365158    0.56905 -0.6417  0.5211
mean: d_y3_d_x4  0.430502    0.43681  0.9856  0.3244
> 
> # for testing state of random number generator
> rnorm( 4 )
[1] -0.6467  0.2789  0.1209 -1.2689
> 
> # calculating marginal effects, conditional
> # (assuming that all other dependent variables are as observed)
> margEffCondObs <- mvProbitMargEff( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ), 
+    cond = TRUE, algorithm = GenzBretz() )
> round( margEffCondObs, 3 )
   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.172     0.205    -0.127    -0.096     0.223    -0.175     0.049
2      0.453     0.185    -0.104    -0.371     0.266    -0.085     0.518
3      0.097     0.343    -0.206    -0.277     0.230    -0.128     0.241
4      0.182     0.223    -0.356    -0.349     0.246    -0.156     0.379
5      0.396     0.265    -0.224    -0.323     0.252    -0.134     0.539
6      0.024     0.145    -0.073    -0.133     0.070    -0.062     0.078
7      0.248     0.145    -0.144    -0.026     0.113    -0.125     0.086
8      0.105     0.350    -0.238    -0.283     0.240    -0.148     0.252
9      0.305     0.030    -0.025    -0.211     0.083    -0.052     0.152
10     0.001     0.232    -0.116    -0.019     0.111    -0.138     0.006
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.385     0.244    -0.036    -0.504     0.302
2     -0.426     0.132    -0.342    -0.468     0.274
3     -0.358     0.193    -0.170    -0.436     0.303
4     -0.373     0.244    -0.264    -0.356     0.567
5     -0.524     0.232    -0.395    -0.539     0.456
6     -0.076     0.065    -0.053    -0.098     0.085
7     -0.310     0.253    -0.066    -0.399     0.333
8     -0.386     0.237    -0.185    -0.467     0.378
9     -0.089     0.057    -0.100    -0.113     0.082
10    -0.149     0.148    -0.005    -0.199     0.166
> margEffCondObsA <- mvProbitMargEff( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = allCoef, data = as.data.frame( cbind( xMat, yMat ) ), 
+    cond = TRUE, algorithm = GenzBretz() )
> all.equal( margEffCondObs, margEffCondObsA )
[1] TRUE
> # now with integrals obtained by the Miwa algorithm, reduced precision
> margEffCondObs1 <- mvProbitMargEff( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    cond = TRUE, algorithm = Miwa( steps = 32 ) )
> round( margEffCondObs1, 3 )
   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.172     0.205    -0.127    -0.096     0.223    -0.175     0.049
2      0.453     0.185    -0.104    -0.371     0.266    -0.085     0.518
3      0.097     0.343    -0.206    -0.277     0.230    -0.128     0.241
4      0.182     0.223    -0.356    -0.349     0.246    -0.156     0.379
5      0.396     0.265    -0.224    -0.323     0.252    -0.134     0.539
6      0.024     0.145    -0.073    -0.133     0.070    -0.062     0.078
7      0.248     0.145    -0.144    -0.026     0.113    -0.125     0.086
8      0.105     0.350    -0.238    -0.283     0.240    -0.148     0.252
9      0.305     0.030    -0.025    -0.211     0.083    -0.052     0.152
10     0.001     0.232    -0.116    -0.019     0.111    -0.138     0.006
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.385     0.244    -0.036    -0.504     0.302
2     -0.426     0.132    -0.342    -0.468     0.274
3     -0.358     0.193    -0.170    -0.436     0.303
4     -0.373     0.244    -0.264    -0.356     0.568
5     -0.524     0.232    -0.395    -0.539     0.455
6     -0.076     0.065    -0.053    -0.098     0.085
7     -0.310     0.253    -0.065    -0.399     0.333
8     -0.386     0.237    -0.185    -0.467     0.379
9     -0.089     0.057    -0.100    -0.113     0.082
10    -0.149     0.148    -0.005    -0.199     0.166
> all.equal( margEffCondObs, margEffCondObs1, tol = 1e-3 )
[1] TRUE
> # now with integrals obtained by the GHK algorithm
> margEffCondObs2 <- mvProbitMargEff( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, data = as.data.frame( cbind( xMat, yMat ) ),
+    cond = TRUE )
> round( margEffCondObs2, 3 )
   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.172     0.205    -0.127    -0.096     0.223    -0.175     0.049
2      0.453     0.185    -0.104    -0.371     0.266    -0.085     0.518
3      0.097     0.343    -0.206    -0.277     0.230    -0.128     0.241
4      0.182     0.223    -0.356    -0.349     0.247    -0.156     0.379
5      0.396     0.265    -0.224    -0.323     0.252    -0.134     0.539
6      0.024     0.145    -0.073    -0.133     0.070    -0.062     0.078
7      0.248     0.145    -0.144    -0.026     0.113    -0.125     0.086
8      0.105     0.350    -0.238    -0.283     0.240    -0.148     0.252
9      0.305     0.029    -0.025    -0.211     0.083    -0.052     0.152
10     0.001     0.232    -0.116    -0.019     0.111    -0.138     0.006
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.385     0.244    -0.036    -0.504     0.302
2     -0.425     0.132    -0.342    -0.468     0.274
3     -0.358     0.193    -0.170    -0.435     0.303
4     -0.374     0.244    -0.264    -0.356     0.568
5     -0.524     0.232    -0.395    -0.539     0.456
6     -0.076     0.065    -0.053    -0.098     0.085
7     -0.310     0.253    -0.065    -0.399     0.333
8     -0.386     0.237    -0.185    -0.467     0.379
9     -0.089     0.058    -0.100    -0.113     0.083
10    -0.149     0.148    -0.005    -0.199     0.166
> all.equal( margEffCondObs, margEffCondObs2, tol = 1e-3 )
[1] TRUE
> all.equal( margEffCondObs1, margEffCondObs2, tol = 1e-3 )
[1] TRUE
> # now with variance covariance matrix and Jacobian
> margEffCondObsV <- mvProbitMargEff( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, 
+    data = as.data.frame( cbind( xMat, yMat ) )[ c(1,5,10), ], 
+    cond = TRUE, vcov = diag( 18 ), returnJacobian = TRUE,
+    algorithm = GenzBretz() )
> round( attr( margEffCondObsV, "vcov" ), 3 )
, , d_y1_d_x1

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.267    -0.002     0.001    -0.090     0.011     0.023     0.087
5      0.480     0.067    -0.187    -0.240     0.013    -0.188    -0.107
10     0.000     0.000     0.000    -0.001     0.000     0.001     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.018    -0.045    -0.062    -0.007    -0.025
5      0.109     0.328     0.045    -0.242     0.137
10     0.000     0.000     0.000     0.000    -0.001

, , d_y2_d_x1

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.002     0.171     0.003    -0.008    -0.019    -0.015     0.007
5      0.067     0.335    -0.024    -0.023    -0.066    -0.138    -0.091
10     0.000     0.263     0.006    -0.002     0.089     0.002     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.119     0.008    -0.001    -0.278     0.003
5      0.083     0.179    -0.037    -0.148     0.087
10    -0.109    -0.002     0.000    -0.202    -0.005

, , d_y3_d_x1

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.001     0.003     0.111    -0.024    -0.014     0.023     0.018
5     -0.187    -0.024     0.307     0.095    -0.060     0.127     0.030
10     0.000     0.006     0.138    -0.004    -0.004     0.066     0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.009    -0.113    -0.006     0.003    -0.210
5      0.026    -0.302    -0.022     0.181    -0.277
10     0.002    -0.064    -0.001    -0.001    -0.105

, , d_y1_d_x2

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.090    -0.008    -0.024     0.110    -0.022    -0.026    -0.058
5     -0.240    -0.023     0.095     0.233    -0.052     0.063    -0.011
10    -0.001    -0.002    -0.004     0.011    -0.004    -0.011    -0.003
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.013     0.019     0.030     0.017     0.045
5     -0.018    -0.216    -0.157     0.111    -0.041
10     0.002     0.005     0.002     0.003     0.008

, , d_y2_d_x2

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.011    -0.019    -0.014    -0.022     0.147    -0.008     0.006
5      0.013    -0.066    -0.060    -0.052     0.189     0.000     0.027
10     0.000     0.089    -0.004    -0.004     0.124     0.008     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.029     0.042    -0.003     0.001     0.044
5     -0.085     0.084     0.042    -0.113     0.103
10    -0.068     0.000     0.000    -0.124    -0.003

, , d_y3_d_x2

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.023    -0.015     0.023    -0.026    -0.008     0.171     0.001
5     -0.188    -0.138     0.127     0.063     0.000     0.430     0.025
10     0.001     0.002     0.066    -0.011     0.008     0.162     0.002
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.043    -0.046    -0.005     0.040    -0.090
5     -0.016    -0.340    -0.099     0.253    -0.154
10    -0.002    -0.071    -0.001    -0.006    -0.117

, , d_y1_d_x3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.087     0.007     0.018    -0.058     0.006     0.001     0.052
5     -0.107    -0.091     0.030    -0.011     0.027     0.025     0.351
10     0.000     0.000     0.001    -0.003     0.000     0.002     0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.015    -0.026    -0.029    -0.015    -0.034
5     -0.166    -0.118     0.240     0.116    -0.101
10     0.000    -0.002    -0.001    -0.001    -0.002

, , d_y2_d_x3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.018    -0.119     0.009     0.013     0.029     0.043    -0.015
5      0.109     0.083     0.026    -0.018    -0.085    -0.016    -0.166
10     0.000    -0.109     0.002     0.002    -0.068    -0.002     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.187    -0.033     0.006     0.240    -0.040
5      0.338     0.037    -0.102     0.008    -0.076
10     0.090     0.002     0.000     0.157     0.004

, , d_y3_d_x3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.045     0.008    -0.113     0.019     0.042    -0.046    -0.026
5      0.328     0.179    -0.302    -0.216     0.084    -0.340    -0.118
10     0.000    -0.002    -0.064     0.005     0.000    -0.071    -0.002
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.033     0.222     0.015    -0.034     0.273
5      0.037     0.706     0.142    -0.392     0.343
10     0.002     0.078     0.001     0.005     0.118

, , d_y1_d_x4

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.062    -0.001    -0.006     0.030    -0.003    -0.005    -0.029
5      0.045    -0.037    -0.022    -0.157     0.042    -0.099     0.240
10     0.000     0.000    -0.001     0.002     0.000    -0.001    -0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.006     0.015     0.022     0.002     0.009
5     -0.102     0.142     0.535    -0.010    -0.144
10     0.000     0.001     0.001     0.000     0.001

, , d_y2_d_x4

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.007    -0.278     0.003     0.017     0.001     0.040    -0.015
5     -0.242    -0.148     0.181     0.111    -0.113     0.253     0.116
10     0.000    -0.202    -0.001     0.003    -0.124    -0.006    -0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.240    -0.034     0.002     0.604    -0.020
5      0.008    -0.392    -0.010     0.564    -0.262
10     0.157     0.005     0.000     0.303     0.011

, , d_y3_d_x4

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.025     0.003    -0.210     0.045     0.044    -0.090    -0.034
5      0.137     0.087    -0.277    -0.041     0.103    -0.154    -0.101
10    -0.001    -0.005    -0.105     0.008    -0.003    -0.117    -0.002
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.040     0.273     0.009    -0.020     0.522
5     -0.076     0.343    -0.144    -0.262     0.479
10     0.004     0.118     0.001     0.011     0.211

> round( drop( attr( margEffCondObsV, "vcov" )[ 1, , ] ), 3 )
          d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
d_y1_d_x1     0.267    -0.002     0.001    -0.090     0.011     0.023     0.087
d_y2_d_x1    -0.002     0.171     0.003    -0.008    -0.019    -0.015     0.007
d_y3_d_x1     0.001     0.003     0.111    -0.024    -0.014     0.023     0.018
d_y1_d_x2    -0.090    -0.008    -0.024     0.110    -0.022    -0.026    -0.058
d_y2_d_x2     0.011    -0.019    -0.014    -0.022     0.147    -0.008     0.006
d_y3_d_x2     0.023    -0.015     0.023    -0.026    -0.008     0.171     0.001
d_y1_d_x3     0.087     0.007     0.018    -0.058     0.006     0.001     0.052
d_y2_d_x3    -0.018    -0.119     0.009     0.013     0.029     0.043    -0.015
d_y3_d_x3    -0.045     0.008    -0.113     0.019     0.042    -0.046    -0.026
d_y1_d_x4    -0.062    -0.001    -0.006     0.030    -0.003    -0.005    -0.029
d_y2_d_x4    -0.007    -0.278     0.003     0.017     0.001     0.040    -0.015
d_y3_d_x4    -0.025     0.003    -0.210     0.045     0.044    -0.090    -0.034
          d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
d_y1_d_x1    -0.018    -0.045    -0.062    -0.007    -0.025
d_y2_d_x1    -0.119     0.008    -0.001    -0.278     0.003
d_y3_d_x1     0.009    -0.113    -0.006     0.003    -0.210
d_y1_d_x2     0.013     0.019     0.030     0.017     0.045
d_y2_d_x2     0.029     0.042    -0.003     0.001     0.044
d_y3_d_x2     0.043    -0.046    -0.005     0.040    -0.090
d_y1_d_x3    -0.015    -0.026    -0.029    -0.015    -0.034
d_y2_d_x3     0.187    -0.033     0.006     0.240    -0.040
d_y3_d_x3    -0.033     0.222     0.015    -0.034     0.273
d_y1_d_x4     0.006     0.015     0.022     0.002     0.009
d_y2_d_x4     0.240    -0.034     0.002     0.604    -0.020
d_y3_d_x4    -0.040     0.273     0.009    -0.020     0.522
> round( attr( margEffCondObsV, "jacobian" ), 3 )
, , b_1_0

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.237    -0.004    -0.005    -0.164     0.021     0.053     0.115
5      0.279     0.013    -0.043    -0.183     0.007    -0.050     0.046
10    -0.005     0.000     0.002     0.046    -0.005    -0.021    -0.019
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.018    -0.049    -0.081     0.005     0.004
5      0.020     0.092    -0.026    -0.041     0.033
10     0.001     0.009     0.014     0.000    -0.001

, , b_1_1

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.276    -0.009    -0.022     0.000     0.000      0.00     0.000
5      0.430    -0.065    -0.091    -0.183     0.007     -0.05     0.046
10     0.000     0.000     0.000     0.000     0.000      0.00     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.000     0.000     0.000     0.000     0.000
5      0.021     0.092    -0.026    -0.041     0.033
10     0.000     0.000     0.000     0.000     0.000

, , b_1_2

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.237    -0.004    -0.005     0.039    -0.005    -0.017     0.115
5      0.000     0.000     0.000     0.247    -0.058    -0.142     0.000
10     0.000     0.000     0.000     0.051    -0.005    -0.023     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.018    -0.049    -0.081     0.005     0.004
5      0.000     0.000     0.000     0.000     0.000
10     0.000     0.000     0.000     0.000     0.000

, , b_1_3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.253     0.005     0.005     0.175    -0.023    -0.057    -0.084
5     -0.175    -0.008     0.027     0.115    -0.004     0.032     0.401
10    -0.006     0.000     0.003     0.058    -0.006    -0.026    -0.019
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.014     0.036     0.087    -0.004    -0.004
5     -0.079    -0.150     0.016     0.025    -0.021
10     0.001     0.009     0.017     0.000    -0.002

, , b_1_4

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.101    -0.002    -0.002    -0.070     0.009     0.023     0.049
5      0.229     0.011    -0.035    -0.151     0.005    -0.041     0.038
10     0.002     0.000    -0.001    -0.018     0.002     0.008     0.007
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.007    -0.021     0.004    -0.003    -0.015
5      0.018     0.077     0.408    -0.098    -0.065
10    -0.001    -0.004    -0.001     0.000    -0.002

, , b_2_0

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.007    -0.209    -0.011     0.024    -0.074     -0.02    -0.014
5     -0.047     0.060     0.024     0.020    -0.113      0.02     0.020
10     0.000     0.220     0.011    -0.003     0.133      0.01     0.001
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.244     0.027     0.003     0.317     0.026
5      0.053    -0.037     0.032     0.063    -0.037
10    -0.226    -0.010     0.000    -0.302    -0.012

, , b_2_1

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.010     0.119     0.004      0.00     0.000      0.00      0.00
5     -0.062     0.406     0.035      0.02    -0.113      0.02      0.02
10     0.000     0.347     0.014      0.00     0.000      0.00      0.00
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.000     0.000     0.000     0.000     0.000
5      0.054    -0.037     0.032     0.063    -0.037
10     0.000     0.000     0.000     0.000     0.000

, , b_2_2

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.007    -0.209    -0.011    -0.003     0.329     0.015    -0.014
5      0.000     0.000     0.000    -0.042     0.293     0.054     0.000
10     0.000     0.000     0.000    -0.004     0.260     0.014     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.244     0.027     0.003     0.317     0.026
5      0.000     0.000     0.000     0.000     0.000
10     0.000     0.000     0.000     0.000     0.000

, , b_2_3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.007     0.224     0.012    -0.025     0.079     0.021     0.011
5      0.029    -0.038    -0.015    -0.012     0.071    -0.012    -0.075
10     0.000     0.275     0.014    -0.004     0.166     0.013     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.068    -0.014    -0.004    -0.339    -0.028
5      0.372     0.058    -0.020    -0.039     0.023
10    -0.157    -0.010     0.000    -0.379    -0.015

, , b_2_4

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.003    -0.089    -0.005     0.010    -0.032    -0.008    -0.006
5     -0.038     0.049     0.020     0.016    -0.093     0.016     0.017
10     0.000    -0.084    -0.004     0.001    -0.051    -0.004     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.105     0.011    -0.002     0.464     0.026
5      0.044    -0.031    -0.035     0.457     0.004
10     0.086     0.004     0.000     0.242     0.008

, , b_3_0

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.023    -0.011    -0.159     0.046    -0.016    -0.126    -0.029
5     -0.074    -0.007     0.221     0.062    -0.014     0.060    -0.035
10     0.001     0.011     0.131    -0.011     0.010     0.154     0.004
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.025     0.243     0.012     0.025     0.286
5      0.004    -0.148    -0.033     0.032    -0.256
10    -0.010    -0.216    -0.002    -0.012    -0.239

, , b_3_1

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.032     0.004     0.101     0.000     0.000      0.00     0.000
5     -0.125     0.049     0.365     0.062    -0.014      0.06    -0.035
10     0.000     0.015     0.273     0.000     0.000      0.00     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.000     0.000     0.000     0.000     0.000
5      0.004    -0.148    -0.034     0.032    -0.256
10     0.000     0.000     0.000     0.000     0.000

, , b_3_2

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.023    -0.011    -0.159    -0.008     0.015     0.260    -0.029
5      0.000     0.000     0.000    -0.062     0.035     0.425     0.000
10     0.000     0.000     0.000    -0.012     0.013     0.296     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.025     0.243     0.012     0.025     0.286
5      0.000     0.000     0.000     0.000     0.000
10     0.000     0.000     0.000     0.000     0.000

, , b_3_3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.025     0.012     0.170    -0.049     0.017     0.134     0.022
5      0.046     0.005    -0.138    -0.039     0.009    -0.037    -0.102
10     0.001     0.014     0.164    -0.014     0.012     0.193     0.003
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.011     0.001    -0.013    -0.026    -0.305
5      0.046     0.457     0.021    -0.020     0.160
10    -0.009    -0.131    -0.002    -0.015    -0.300

, , b_3_4

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.010    -0.005    -0.068     0.019    -0.007    -0.054    -0.012
5     -0.061    -0.006     0.182     0.051    -0.011     0.049    -0.029
10     0.000    -0.004    -0.050     0.004    -0.004    -0.059    -0.002
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.010     0.103    -0.003     0.025     0.381
5      0.003    -0.121    -0.152     0.075     0.156
10     0.004     0.082     0.000     0.008     0.232

, , R_1_2

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1      0.012    -0.017     0.002    -0.108     0.060     0.057     0.045
5     -0.263    -0.310     0.054     0.001     0.141     0.166     0.360
10     0.000     0.000     0.000    -0.008     0.006     0.006     0.002
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.029    -0.031    -0.002     0.007    -0.008
5     -0.354    -0.203     0.366     0.286    -0.106
10    -0.001     0.000     0.000     0.000    -0.001

, , R_1_3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1     -0.030    -0.003    -0.046     0.168    -0.015     0.120    -0.106
5     -0.135    -0.152    -0.008     0.218    -0.005     0.334    -0.174
10    -0.003     0.000    -0.003     0.041    -0.003     0.033    -0.014
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1      0.012    -0.082     0.024     0.002     0.030
5     -0.033    -0.404    -0.448     0.173     0.092
10     0.001    -0.012     0.004     0.000     0.005

, , R_2_3

   d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       0.00     0.100    -0.115     0.013     0.144    -0.202    -0.005
5       0.11     0.191    -0.235    -0.047     0.196    -0.260    -0.063
10      0.00     0.107    -0.127     0.001     0.089    -0.084     0.000
   d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1     -0.221     0.279     0.000    -0.264     0.341
5     -0.237     0.426    -0.057    -0.461     0.519
10    -0.081     0.079     0.000    -0.098     0.098

> round( drop( attr( margEffCondObsV, "jacobian" )[ 1, , ] ), 3 )
           b_1_0  b_1_1  b_1_2  b_1_3  b_1_4  b_2_0  b_2_1  b_2_2  b_2_3  b_2_4
d_y1_d_x1  0.237  0.276  0.237 -0.253  0.101 -0.007 -0.010 -0.007  0.007 -0.003
d_y2_d_x1 -0.004 -0.009 -0.004  0.005 -0.002 -0.209  0.119 -0.209  0.224 -0.089
d_y3_d_x1 -0.005 -0.022 -0.005  0.005 -0.002 -0.011  0.004 -0.011  0.012 -0.005
d_y1_d_x2 -0.164  0.000  0.039  0.175 -0.070  0.024  0.000 -0.003 -0.025  0.010
d_y2_d_x2  0.021  0.000 -0.005 -0.023  0.009 -0.074  0.000  0.329  0.079 -0.032
d_y3_d_x2  0.053  0.000 -0.017 -0.057  0.023 -0.020  0.000  0.015  0.021 -0.008
d_y1_d_x3  0.115  0.000  0.115 -0.084  0.049 -0.014  0.000 -0.014  0.011 -0.006
d_y2_d_x3 -0.018  0.000 -0.018  0.014 -0.007  0.244  0.000  0.244  0.068  0.105
d_y3_d_x3 -0.049  0.000 -0.049  0.036 -0.021  0.027  0.000  0.027 -0.014  0.011
d_y1_d_x4 -0.081  0.000 -0.081  0.087  0.004  0.003  0.000  0.003 -0.004 -0.002
d_y2_d_x4  0.005  0.000  0.005 -0.004 -0.003  0.317  0.000  0.317 -0.339  0.464
d_y3_d_x4  0.004  0.000  0.004 -0.004 -0.015  0.026  0.000  0.026 -0.028  0.026
           b_3_0  b_3_1  b_3_2  b_3_3  b_3_4  R_1_2  R_1_3  R_2_3
d_y1_d_x1 -0.023 -0.032 -0.023  0.025 -0.010  0.012 -0.030  0.000
d_y2_d_x1 -0.011  0.004 -0.011  0.012 -0.005 -0.017 -0.003  0.100
d_y3_d_x1 -0.159  0.101 -0.159  0.170 -0.068  0.002 -0.046 -0.115
d_y1_d_x2  0.046  0.000 -0.008 -0.049  0.019 -0.108  0.168  0.013
d_y2_d_x2 -0.016  0.000  0.015  0.017 -0.007  0.060 -0.015  0.144
d_y3_d_x2 -0.126  0.000  0.260  0.134 -0.054  0.057  0.120 -0.202
d_y1_d_x3 -0.029  0.000 -0.029  0.022 -0.012  0.045 -0.106 -0.005
d_y2_d_x3  0.025  0.000  0.025 -0.011  0.010 -0.029  0.012 -0.221
d_y3_d_x3  0.243  0.000  0.243  0.001  0.103 -0.031 -0.082  0.279
d_y1_d_x4  0.012  0.000  0.012 -0.013 -0.003 -0.002  0.024  0.000
d_y2_d_x4  0.025  0.000  0.025 -0.026  0.025  0.007  0.002 -0.264
d_y3_d_x4  0.286  0.000  0.286 -0.305  0.381 -0.008  0.030  0.341
> print( summary( margEffCondObsV ), digits = 3 )
             Estimate Std. error z value Pr(> z)
1: d_y1_d_x1  0.17200    0.51683    0.33    0.74
1: d_y2_d_x1  0.20542    0.41312    0.50    0.62
1: d_y3_d_x1 -0.12684    0.33246   -0.38    0.70
1: d_y1_d_x2 -0.09566    0.33145   -0.29    0.77
1: d_y2_d_x2  0.22332    0.38384    0.58    0.56
1: d_y3_d_x2 -0.17476    0.41304   -0.42    0.67
1: d_y1_d_x3  0.04937    0.22845    0.22    0.83
1: d_y2_d_x3 -0.38496    0.43253   -0.89    0.37
1: d_y3_d_x3  0.24421    0.47164    0.52    0.60
1: d_y1_d_x4 -0.03571    0.14724   -0.24    0.81
1: d_y2_d_x4 -0.50421    0.77745   -0.65    0.52
1: d_y3_d_x4  0.30197    0.72252    0.42    0.68
2: d_y1_d_x1  0.39598    0.69317    0.57    0.57
2: d_y2_d_x1  0.26512    0.57906    0.46    0.65
2: d_y3_d_x1 -0.22406    0.55429   -0.40    0.69
2: d_y1_d_x2 -0.32295    0.48236   -0.67    0.50
2: d_y2_d_x2  0.25167    0.43431    0.58    0.56
2: d_y3_d_x2 -0.13425    0.65603   -0.20    0.84
2: d_y1_d_x3  0.53896    0.59275    0.91    0.36
2: d_y2_d_x3 -0.52391    0.58167   -0.90    0.37
2: d_y3_d_x3  0.23199    0.84006    0.28    0.78
2: d_y1_d_x4 -0.39507    0.73153   -0.54    0.59
2: d_y2_d_x4 -0.53871    0.75115   -0.72    0.47
2: d_y3_d_x4  0.45553    0.69236    0.66    0.51
3: d_y1_d_x1  0.00139    0.00853    0.16    0.87
3: d_y2_d_x1  0.23197    0.51327    0.45    0.65
3: d_y3_d_x1 -0.11609    0.37107   -0.31    0.75
3: d_y1_d_x2 -0.01857    0.10363   -0.18    0.86
3: d_y2_d_x2  0.11099    0.35196    0.32    0.75
3: d_y3_d_x2 -0.13782    0.40276   -0.34    0.73
3: d_y1_d_x3  0.00597    0.03147    0.19    0.85
3: d_y2_d_x3 -0.14919    0.29985   -0.50    0.62
3: d_y3_d_x3  0.14823    0.27851    0.53    0.59
3: d_y1_d_x4 -0.00457    0.02305   -0.20    0.84
3: d_y2_d_x4 -0.19920    0.55082   -0.36    0.72
3: d_y3_d_x4  0.16555    0.45984    0.36    0.72
> margEffCondObsVA <- mvProbitMargEff( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = allCoef, data = as.data.frame( cbind( xMat, yMat ) )[ c(1,5,10), ], 
+    cond = TRUE, vcov = diag( 18 ), returnJacobian = TRUE,
+    algorithm = GenzBretz() )
> all.equal( margEffCondObs, margEffCondObsA )
[1] TRUE
> # now with Jacobian but without variance covariance matrix
> margEffCondObsJac <- mvProbitMargEff( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, 
+    data = as.data.frame( cbind( xMat, yMat ) )[ c(1,5,10), ], 
+    cond = TRUE, returnJacobian = TRUE, algorithm = GenzBretz() )
> all.equal( attr( margEffCondObsJac, "jacobian" ), 
+    attr( margEffCondObsV, "jacobian" ) )
[1] TRUE
> # now with mean values of marginal effects
> margEffCondObsM <- mvProbitMargEff( cbind( y1, y2, y3 ) ~ x1 + x2 + x3 + x4, 
+    coef = c( beta ), sigma = sigma, 
+    data = as.data.frame( cbind( xMat, yMat ) )[ c(1,5,10), ], 
+    cond = TRUE, vcov = diag( 18 ), addMean = TRUE, returnJacobian = TRUE,
+    algorithm = GenzBretz() )
> all.equal( margEffCondObsV, margEffCondObsM[ 1:3, ], check.attributes = FALSE )
[1] TRUE
> round( margEffCondObsM, 3 )
     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.172     0.205    -0.127    -0.096     0.223    -0.175     0.049
2        0.396     0.265    -0.224    -0.323     0.252    -0.134     0.539
3        0.001     0.232    -0.116    -0.019     0.111    -0.138     0.006
mean     0.190     0.234    -0.156    -0.146     0.195    -0.149     0.198
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.385     0.244    -0.036    -0.504     0.302
2       -0.524     0.232    -0.395    -0.539     0.456
3       -0.149     0.148    -0.005    -0.199     0.166
mean    -0.353     0.208    -0.145    -0.414     0.308
> all.equal( attr( margEffCondObsV, "vcov" ), 
+    attr( margEffCondObsM, "vcov" )[ 1:3, , ] )
[1] TRUE
> round( attr( margEffCondObsM, "vcov" ), 3 )
, , d_y1_d_x1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.267    -0.002     0.001    -0.090     0.011     0.023     0.087
5        0.480     0.067    -0.187    -0.240     0.013    -0.188    -0.107
10       0.000     0.000     0.000    -0.001     0.000     0.001     0.000
mean     0.142     0.006    -0.035    -0.057     0.005    -0.032    -0.002
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.018    -0.045    -0.062    -0.007    -0.025
5        0.109     0.328     0.045    -0.242     0.137
10       0.000     0.000     0.000     0.000    -0.001
mean     0.008     0.047    -0.001    -0.043     0.012

, , d_y2_d_x1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.002     0.171     0.003    -0.008    -0.019    -0.015     0.007
5        0.067     0.335    -0.024    -0.023    -0.066    -0.138    -0.091
10       0.000     0.263     0.006    -0.002     0.089     0.002     0.000
mean     0.006     0.149    -0.009    -0.003    -0.001    -0.039    -0.015
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.119     0.008    -0.001    -0.278     0.003
5        0.083     0.179    -0.037    -0.148     0.087
10      -0.109    -0.002     0.000    -0.202    -0.005
mean     0.002     0.048    -0.005    -0.106     0.033

, , d_y3_d_x1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.001     0.003     0.111    -0.024    -0.014     0.023     0.018
5       -0.187    -0.024     0.307     0.095    -0.060     0.127     0.030
10       0.000     0.006     0.138    -0.004    -0.004     0.066     0.001
mean    -0.035    -0.009     0.101     0.012    -0.025     0.023     0.002
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.009    -0.113    -0.006     0.003    -0.210
5        0.026    -0.302    -0.022     0.181    -0.277
10       0.002    -0.064    -0.001    -0.001    -0.105
mean     0.027    -0.054     0.003     0.049    -0.088

, , d_y1_d_x2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.090    -0.008    -0.024     0.110    -0.022    -0.026    -0.058
5       -0.240    -0.023     0.095     0.233    -0.052     0.063    -0.011
10      -0.001    -0.002    -0.004     0.011    -0.004    -0.011    -0.003
mean    -0.057    -0.003     0.012     0.073    -0.019     0.003    -0.011
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.013     0.019     0.030     0.017     0.045
5       -0.018    -0.216    -0.157     0.111    -0.041
10       0.002     0.005     0.002     0.003     0.008
mean     0.000    -0.043    -0.032     0.021     0.008

, , d_y2_d_x2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.011    -0.019    -0.014    -0.022     0.147    -0.008     0.006
5        0.013    -0.066    -0.060    -0.052     0.189     0.000     0.027
10       0.000     0.089    -0.004    -0.004     0.124     0.008     0.000
mean     0.005    -0.001    -0.025    -0.019     0.129    -0.004     0.001
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.029     0.042    -0.003     0.001     0.044
5       -0.085     0.084     0.042    -0.113     0.103
10      -0.068     0.000     0.000    -0.124    -0.003
mean    -0.006     0.042     0.008    -0.053     0.044

, , d_y3_d_x2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.023    -0.015     0.023    -0.026    -0.008     0.171     0.001
5       -0.188    -0.138     0.127     0.063     0.000     0.430     0.025
10       0.001     0.002     0.066    -0.011     0.008     0.162     0.002
mean    -0.032    -0.039     0.023     0.003    -0.004     0.188    -0.012
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.043    -0.046    -0.005     0.040    -0.090
5       -0.016    -0.340    -0.099     0.253    -0.154
10      -0.002    -0.071    -0.001    -0.006    -0.117
mean     0.029    -0.045    -0.007     0.069    -0.047

, , d_y1_d_x3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.087     0.007     0.018    -0.058     0.006     0.001     0.052
5       -0.107    -0.091     0.030    -0.011     0.027     0.025     0.351
10       0.000     0.000     0.001    -0.003     0.000     0.002     0.001
mean    -0.002    -0.015     0.002    -0.011     0.001    -0.012     0.045
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.015    -0.026    -0.029    -0.015    -0.034
5       -0.166    -0.118     0.240     0.116    -0.101
10       0.000    -0.002    -0.001    -0.001    -0.002
mean    -0.017    -0.006     0.037     0.019    -0.016

, , d_y2_d_x3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.018    -0.119     0.009     0.013     0.029     0.043    -0.015
5        0.109     0.083     0.026    -0.018    -0.085    -0.016    -0.166
10       0.000    -0.109     0.002     0.002    -0.068    -0.002     0.000
mean     0.008     0.002     0.027     0.000    -0.006     0.029    -0.017
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.187    -0.033     0.006     0.240    -0.040
5        0.338     0.037    -0.102     0.008    -0.076
10       0.090     0.002     0.000     0.157     0.004
mean     0.072    -0.032    -0.013     0.052    -0.051

, , d_y3_d_x3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.045     0.008    -0.113     0.019     0.042    -0.046    -0.026
5        0.328     0.179    -0.302    -0.216     0.084    -0.340    -0.118
10       0.000    -0.002    -0.064     0.005     0.000    -0.071    -0.002
mean     0.047     0.048    -0.054    -0.043     0.042    -0.045    -0.006
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.033     0.222     0.015    -0.034     0.273
5        0.037     0.706     0.142    -0.392     0.343
10       0.002     0.078     0.001     0.005     0.118
mean    -0.032     0.129     0.010    -0.097     0.084

, , d_y1_d_x4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.062    -0.001    -0.006     0.030    -0.003    -0.005    -0.029
5        0.045    -0.037    -0.022    -0.157     0.042    -0.099     0.240
10       0.000     0.000    -0.001     0.002     0.000    -0.001    -0.001
mean    -0.001    -0.005     0.003    -0.032     0.008    -0.007     0.037
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.006     0.015     0.022     0.002     0.009
5       -0.102     0.142     0.535    -0.010    -0.144
10       0.000     0.001     0.001     0.000     0.001
mean    -0.013     0.010     0.060     0.001    -0.033

, , d_y2_d_x4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.007    -0.278     0.003     0.017     0.001     0.040    -0.015
5       -0.242    -0.148     0.181     0.111    -0.113     0.253     0.116
10       0.000    -0.202    -0.001     0.003    -0.124    -0.006    -0.001
mean    -0.043    -0.106     0.049     0.021    -0.053     0.069     0.019
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.240    -0.034     0.002     0.604    -0.020
5        0.008    -0.392    -0.010     0.564    -0.262
10       0.157     0.005     0.000     0.303     0.011
mean     0.052    -0.097     0.001     0.318    -0.070

, , d_y3_d_x4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.025     0.003    -0.210     0.045     0.044    -0.090    -0.034
5        0.137     0.087    -0.277    -0.041     0.103    -0.154    -0.101
10      -0.001    -0.005    -0.105     0.008    -0.003    -0.117    -0.002
mean     0.012     0.033    -0.088     0.008     0.044    -0.047    -0.016
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.040     0.273     0.009    -0.020     0.522
5       -0.076     0.343    -0.144    -0.262     0.479
10       0.004     0.118     0.001     0.011     0.211
mean    -0.051     0.084    -0.033    -0.070     0.216

> round( drop( attr( margEffCondObsM, "vcov" )[ 4, , ] ), 3 )
          d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
d_y1_d_x1     0.142     0.006    -0.035    -0.057     0.005    -0.032    -0.002
d_y2_d_x1     0.006     0.149    -0.009    -0.003    -0.001    -0.039    -0.015
d_y3_d_x1    -0.035    -0.009     0.101     0.012    -0.025     0.023     0.002
d_y1_d_x2    -0.057    -0.003     0.012     0.073    -0.019     0.003    -0.011
d_y2_d_x2     0.005    -0.001    -0.025    -0.019     0.129    -0.004     0.001
d_y3_d_x2    -0.032    -0.039     0.023     0.003    -0.004     0.188    -0.012
d_y1_d_x3    -0.002    -0.015     0.002    -0.011     0.001    -0.012     0.045
d_y2_d_x3     0.008     0.002     0.027     0.000    -0.006     0.029    -0.017
d_y3_d_x3     0.047     0.048    -0.054    -0.043     0.042    -0.045    -0.006
d_y1_d_x4    -0.001    -0.005     0.003    -0.032     0.008    -0.007     0.037
d_y2_d_x4    -0.043    -0.106     0.049     0.021    -0.053     0.069     0.019
d_y3_d_x4     0.012     0.033    -0.088     0.008     0.044    -0.047    -0.016
          d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
d_y1_d_x1     0.008     0.047    -0.001    -0.043     0.012
d_y2_d_x1     0.002     0.048    -0.005    -0.106     0.033
d_y3_d_x1     0.027    -0.054     0.003     0.049    -0.088
d_y1_d_x2     0.000    -0.043    -0.032     0.021     0.008
d_y2_d_x2    -0.006     0.042     0.008    -0.053     0.044
d_y3_d_x2     0.029    -0.045    -0.007     0.069    -0.047
d_y1_d_x3    -0.017    -0.006     0.037     0.019    -0.016
d_y2_d_x3     0.072    -0.032    -0.013     0.052    -0.051
d_y3_d_x3    -0.032     0.129     0.010    -0.097     0.084
d_y1_d_x4    -0.013     0.010     0.060     0.001    -0.033
d_y2_d_x4     0.052    -0.097     0.001     0.318    -0.070
d_y3_d_x4    -0.051     0.084    -0.033    -0.070     0.216
> all.equal( attr( margEffCondObsV, "jacobian" ), 
+    attr( margEffCondObsM, "jacobian" )[ 1:3, , ] )
[1] TRUE
> round( attr( margEffCondObsM, "jacobian" ), 3 )
, , b_1_0

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.237    -0.004    -0.005    -0.164     0.021     0.053     0.115
5        0.279     0.013    -0.043    -0.183     0.007    -0.050     0.046
10      -0.005     0.000     0.002     0.046    -0.005    -0.021    -0.019
mean     0.171     0.003    -0.015    -0.100     0.008    -0.006     0.048
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.018    -0.049    -0.081     0.005     0.004
5        0.020     0.092    -0.026    -0.041     0.033
10       0.001     0.009     0.014     0.000    -0.001
mean     0.001     0.017    -0.031    -0.012     0.012

, , b_1_1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.276    -0.009    -0.022     0.000     0.000     0.000     0.000
5        0.430    -0.065    -0.091    -0.183     0.007    -0.050     0.046
10       0.000     0.000     0.000     0.000     0.000     0.000     0.000
mean     0.235    -0.025    -0.038    -0.061     0.002    -0.017     0.015
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.000     0.000     0.000     0.000     0.000
5        0.021     0.092    -0.026    -0.041     0.033
10       0.000     0.000     0.000     0.000     0.000
mean     0.007     0.031    -0.009    -0.014     0.011

, , b_1_2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.237    -0.004    -0.005     0.039    -0.005    -0.017     0.115
5        0.000     0.000     0.000     0.247    -0.058    -0.142     0.000
10       0.000     0.000     0.000     0.051    -0.005    -0.023     0.000
mean     0.079    -0.001    -0.002     0.112    -0.023    -0.061     0.038
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.018    -0.049    -0.081     0.005     0.004
5        0.000     0.000     0.000     0.000     0.000
10       0.000     0.000     0.000     0.000     0.000
mean    -0.006    -0.016    -0.027     0.002     0.001

, , b_1_3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.253     0.005     0.005     0.175    -0.023    -0.057    -0.084
5       -0.175    -0.008     0.027     0.115    -0.004     0.032     0.401
10      -0.006     0.000     0.003     0.058    -0.006    -0.026    -0.019
mean    -0.145    -0.001     0.011     0.116    -0.011    -0.017     0.099
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.014     0.036     0.087    -0.004    -0.004
5       -0.079    -0.150     0.016     0.025    -0.021
10       0.001     0.009     0.017     0.000    -0.002
mean    -0.021    -0.035     0.040     0.007    -0.009

, , b_1_4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.101    -0.002    -0.002    -0.070     0.009     0.023     0.049
5        0.229     0.011    -0.035    -0.151     0.005    -0.041     0.038
10       0.002     0.000    -0.001    -0.018     0.002     0.008     0.007
mean     0.111     0.003    -0.013    -0.079     0.005    -0.004     0.031
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.007    -0.021     0.004    -0.003    -0.015
5        0.018     0.077     0.408    -0.098    -0.065
10      -0.001    -0.004    -0.001     0.000    -0.002
mean     0.003     0.017     0.137    -0.034    -0.027

, , b_2_0

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.007    -0.209    -0.011     0.024    -0.074    -0.020    -0.014
5       -0.047     0.060     0.024     0.020    -0.113     0.020     0.020
10       0.000     0.220     0.011    -0.003     0.133     0.010     0.001
mean    -0.018     0.024     0.008     0.013    -0.018     0.003     0.002
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.244     0.027     0.003     0.317     0.026
5        0.053    -0.037     0.032     0.063    -0.037
10      -0.226    -0.010     0.000    -0.302    -0.012
mean     0.024    -0.007     0.012     0.026    -0.008

, , b_2_1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.010     0.119     0.004     0.000     0.000     0.000     0.000
5       -0.062     0.406     0.035     0.020    -0.113     0.020     0.020
10       0.000     0.347     0.014     0.000     0.000     0.000     0.000
mean    -0.024     0.291     0.018     0.007    -0.038     0.007     0.007
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.000     0.000     0.000     0.000     0.000
5        0.054    -0.037     0.032     0.063    -0.037
10       0.000     0.000     0.000     0.000     0.000
mean     0.018    -0.012     0.011     0.021    -0.012

, , b_2_2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.007    -0.209    -0.011    -0.003     0.329     0.015    -0.014
5        0.000     0.000     0.000    -0.042     0.293     0.054     0.000
10       0.000     0.000     0.000    -0.004     0.260     0.014     0.000
mean    -0.002    -0.070    -0.004    -0.016     0.294     0.028    -0.005
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.244     0.027     0.003     0.317     0.026
5        0.000     0.000     0.000     0.000     0.000
10       0.000     0.000     0.000     0.000     0.000
mean     0.081     0.009     0.001     0.106     0.009

, , b_2_3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.007     0.224     0.012    -0.025     0.079     0.021     0.011
5        0.029    -0.038    -0.015    -0.012     0.071    -0.012    -0.075
10       0.000     0.275     0.014    -0.004     0.166     0.013     0.000
mean     0.012     0.154     0.003    -0.014     0.105     0.007    -0.021
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.068    -0.014    -0.004    -0.339    -0.028
5        0.372     0.058    -0.020    -0.039     0.023
10      -0.157    -0.010     0.000    -0.379    -0.015
mean     0.095     0.011    -0.008    -0.252    -0.007

, , b_2_4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.003    -0.089    -0.005     0.010    -0.032    -0.008    -0.006
5       -0.038     0.049     0.020     0.016    -0.093     0.016     0.017
10       0.000    -0.084    -0.004     0.001    -0.051    -0.004     0.000
mean    -0.014    -0.041     0.004     0.009    -0.058     0.001     0.004
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.105     0.011    -0.002     0.464     0.026
5        0.044    -0.031    -0.035     0.457     0.004
10       0.086     0.004     0.000     0.242     0.008
mean     0.078    -0.005    -0.012     0.388     0.013

, , b_3_0

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.023    -0.011    -0.159     0.046    -0.016    -0.126    -0.029
5       -0.074    -0.007     0.221     0.062    -0.014     0.060    -0.035
10       0.001     0.011     0.131    -0.011     0.010     0.154     0.004
mean    -0.032    -0.002     0.064     0.032    -0.007     0.029    -0.020
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.025     0.243     0.012     0.025     0.286
5        0.004    -0.148    -0.033     0.032    -0.256
10      -0.010    -0.216    -0.002    -0.012    -0.239
mean     0.006    -0.041    -0.008     0.015    -0.070

, , b_3_1

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.032     0.004     0.101     0.000     0.000      0.00     0.000
5       -0.125     0.049     0.365     0.062    -0.014      0.06    -0.035
10       0.000     0.015     0.273     0.000     0.000      0.00     0.000
mean    -0.052     0.023     0.246     0.021    -0.005      0.02    -0.012
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.000     0.000     0.000     0.000     0.000
5        0.004    -0.148    -0.034     0.032    -0.256
10       0.000     0.000     0.000     0.000     0.000
mean     0.001    -0.049    -0.011     0.011    -0.085

, , b_3_2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.023    -0.011    -0.159    -0.008     0.015     0.260    -0.029
5        0.000     0.000     0.000    -0.062     0.035     0.425     0.000
10       0.000     0.000     0.000    -0.012     0.013     0.296     0.000
mean    -0.008    -0.004    -0.053    -0.027     0.021     0.327    -0.010
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.025     0.243     0.012     0.025     0.286
5        0.000     0.000     0.000     0.000     0.000
10       0.000     0.000     0.000     0.000     0.000
mean     0.008     0.081     0.004     0.008     0.095

, , b_3_3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.025     0.012     0.170    -0.049     0.017     0.134     0.022
5        0.046     0.005    -0.138    -0.039     0.009    -0.037    -0.102
10       0.001     0.014     0.164    -0.014     0.012     0.193     0.003
mean     0.024     0.010     0.065    -0.034     0.012     0.097    -0.026
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.011     0.001    -0.013    -0.026    -0.305
5        0.046     0.457     0.021    -0.020     0.160
10      -0.009    -0.131    -0.002    -0.015    -0.300
mean     0.009     0.109     0.002    -0.020    -0.148

, , b_3_4

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.010    -0.005    -0.068     0.019    -0.007    -0.054    -0.012
5       -0.061    -0.006     0.182     0.051    -0.011     0.049    -0.029
10       0.000    -0.004    -0.050     0.004    -0.004    -0.059    -0.002
mean    -0.024    -0.005     0.021     0.025    -0.007    -0.021    -0.014
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.010     0.103    -0.003     0.025     0.381
5        0.003    -0.121    -0.152     0.075     0.156
10       0.004     0.082     0.000     0.008     0.232
mean     0.006     0.022    -0.052     0.036     0.256

, , R_1_2

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.012    -0.017     0.002    -0.108     0.060     0.057     0.045
5       -0.263    -0.310     0.054     0.001     0.141     0.166     0.360
10       0.000     0.000     0.000    -0.008     0.006     0.006     0.002
mean    -0.083    -0.109     0.019    -0.038     0.069     0.076     0.136
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.029    -0.031    -0.002     0.007    -0.008
5       -0.354    -0.203     0.366     0.286    -0.106
10      -0.001     0.000     0.000     0.000    -0.001
mean    -0.128    -0.078     0.121     0.098    -0.038

, , R_1_3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1       -0.030    -0.003    -0.046     0.168    -0.015     0.120    -0.106
5       -0.135    -0.152    -0.008     0.218    -0.005     0.334    -0.174
10      -0.003     0.000    -0.003     0.041    -0.003     0.033    -0.014
mean    -0.056    -0.052    -0.019     0.142    -0.008     0.162    -0.098
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1        0.012    -0.082     0.024     0.002     0.030
5       -0.033    -0.404    -0.448     0.173     0.092
10       0.001    -0.012     0.004     0.000     0.005
mean    -0.007    -0.166    -0.140     0.058     0.042

, , R_2_3

     d_y1_d_x1 d_y2_d_x1 d_y3_d_x1 d_y1_d_x2 d_y2_d_x2 d_y3_d_x2 d_y1_d_x3
1        0.000     0.100    -0.115     0.013     0.144    -0.202    -0.005
5        0.110     0.191    -0.235    -0.047     0.196    -0.260    -0.063
10       0.000     0.107    -0.127     0.001     0.089    -0.084     0.000
mean     0.036     0.133    -0.159    -0.011     0.143    -0.182    -0.023
     d_y2_d_x3 d_y3_d_x3 d_y1_d_x4 d_y2_d_x4 d_y3_d_x4
1       -0.221     0.279     0.000    -0.264     0.341
5       -0.237     0.426    -0.057    -0.461     0.519
10      -0.081     0.079     0.000    -0.098     0.098
mean    -0.179     0.261    -0.019    -0.274     0.319

> round( drop( attr( margEffCondObsM, "jacobian" )[ 4, , ] ), 3 )
           b_1_0  b_1_1  b_1_2  b_1_3  b_1_4  b_2_0  b_2_1  b_2_2  b_2_3  b_2_4
d_y1_d_x1  0.171  0.235  0.079 -0.145  0.111 -0.018 -0.024 -0.002  0.012 -0.014
d_y2_d_x1  0.003 -0.025 -0.001 -0.001  0.003  0.024  0.291 -0.070  0.154 -0.041
d_y3_d_x1 -0.015 -0.038 -0.002  0.011 -0.013  0.008  0.018 -0.004  0.003  0.004
d_y1_d_x2 -0.100 -0.061  0.112  0.116 -0.079  0.013  0.007 -0.016 -0.014  0.009
d_y2_d_x2  0.008  0.002 -0.023 -0.011  0.005 -0.018 -0.038  0.294  0.105 -0.058
d_y3_d_x2 -0.006 -0.017 -0.061 -0.017 -0.004  0.003  0.007  0.028  0.007  0.001
d_y1_d_x3  0.048  0.015  0.038  0.099  0.031  0.002  0.007 -0.005 -0.021  0.004
d_y2_d_x3  0.001  0.007 -0.006 -0.021  0.003  0.024  0.018  0.081  0.095  0.078
d_y3_d_x3  0.017  0.031 -0.016 -0.035  0.017 -0.007 -0.012  0.009  0.011 -0.005
d_y1_d_x4 -0.031 -0.009 -0.027  0.040  0.137  0.012  0.011  0.001 -0.008 -0.012
d_y2_d_x4 -0.012 -0.014  0.002  0.007 -0.034  0.026  0.021  0.106 -0.252  0.388
d_y3_d_x4  0.012  0.011  0.001 -0.009 -0.027 -0.008 -0.012  0.009 -0.007  0.013
           b_3_0  b_3_1  b_3_2  b_3_3  b_3_4  R_1_2  R_1_3  R_2_3
d_y1_d_x1 -0.032 -0.052 -0.008  0.024 -0.024 -0.083 -0.056  0.036
d_y2_d_x1 -0.002  0.023 -0.004  0.010 -0.005 -0.109 -0.052  0.133
d_y3_d_x1  0.064  0.246 -0.053  0.065  0.021  0.019 -0.019 -0.159
d_y1_d_x2  0.032  0.021 -0.027 -0.034  0.025 -0.038  0.142 -0.011
d_y2_d_x2 -0.007 -0.005  0.021  0.012 -0.007  0.069 -0.008  0.143
d_y3_d_x2  0.029  0.020  0.327  0.097 -0.021  0.076  0.162 -0.182
d_y1_d_x3 -0.020 -0.012 -0.010 -0.026 -0.014  0.136 -0.098 -0.023
d_y2_d_x3  0.006  0.001  0.008  0.009  0.006 -0.128 -0.007 -0.179
d_y3_d_x3 -0.041 -0.049  0.081  0.109  0.022 -0.078 -0.166  0.261
d_y1_d_x4 -0.008 -0.011  0.004  0.002 -0.052  0.121 -0.140 -0.019
d_y2_d_x4  0.015  0.011  0.008 -0.020  0.036  0.098  0.058 -0.274
d_y3_d_x4 -0.070 -0.085  0.095 -0.148  0.256 -0.038  0.042  0.319
> all.equal( summary( margEffCondObsV )[ , ], summary( margEffCondObsM )[ 1:36, ],
+    check.attributes = FALSE )
[1] TRUE
> print( summary( margEffCondObsM )[ -( 1:24 ), ], digits = 3 )
                Estimate Std. error z value Pr(> z)
3: d_y1_d_x1     0.00139    0.00853   0.163   0.870
3: d_y2_d_x1     0.23197    0.51327   0.452   0.651
3: d_y3_d_x1    -0.11609    0.37107  -0.313   0.754
3: d_y1_d_x2    -0.01857    0.10363  -0.179   0.858
3: d_y2_d_x2     0.11099    0.35196   0.315   0.752
3: d_y3_d_x2    -0.13782    0.40276  -0.342   0.732
3: d_y1_d_x3     0.00597    0.03147   0.190   0.850
3: d_y2_d_x3    -0.14919    0.29985  -0.498   0.619
3: d_y3_d_x3     0.14823    0.27851   0.532   0.595
3: d_y1_d_x4    -0.00457    0.02305  -0.198   0.843
3: d_y2_d_x4    -0.19920    0.55082  -0.362   0.718
3: d_y3_d_x4     0.16555    0.45984   0.360   0.719
mean: d_y1_d_x1  0.18979    0.37622   0.504   0.614
mean: d_y2_d_x1  0.23417    0.38572   0.607   0.544
mean: d_y3_d_x1 -0.15566    0.31714  -0.491   0.624
mean: d_y1_d_x2 -0.14573    0.26974  -0.540   0.589
mean: d_y2_d_x2  0.19533    0.35962   0.543   0.587
mean: d_y3_d_x2 -0.14894    0.43387  -0.343   0.731
mean: d_y1_d_x3  0.19810    0.21293   0.930   0.352
mean: d_y2_d_x3 -0.35269    0.26829  -1.315   0.189
mean: d_y3_d_x3  0.20814    0.35852   0.581   0.562
mean: d_y1_d_x4 -0.14512    0.24531  -0.592   0.554
mean: d_y2_d_x4 -0.41404    0.56411  -0.734   0.463
mean: d_y3_d_x4  0.30768    0.46437   0.663   0.508
> 
> # for testing state of random number generator
> rnorm( 4 )
[1]  0.1870  0.3303 -1.2091  1.9202
> 
> 
> proc.time()
   user  system elapsed 
  75.52    0.22   75.78 
